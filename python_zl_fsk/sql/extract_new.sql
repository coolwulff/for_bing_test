-- 筛选风湿入组患者
DROP TABLE IF EXISTS skzbk.fs_medicalrecordmain_ls_temp;
CREATE TABLE skzbk.fs_medicalrecordmain_ls_temp AS 
select m.empi, c.MedicalRecordID, a.inhospitaldeptcode, a.InHospitalDeptName, a.OutHospitalDeptName, a.OutHospitalWardName, a.EncounterID, a.patientno, a.patientname, a.inpatientnumber, to_date(a.inhospitaltime) AS inhospitaltime, to_date(a.OutHospitalTime) AS OutHospitalTime, to_date(c.OperateDate) as OperateDate, c.OperateCODE, c.OperateName, c.operateidx, c.operatedoctorname, c.operatefirstname, concat_ws(';', collect_set(replace(b.diagnosecode,'，','，'))) as diagnosecode, concat_ws(';', collect_set(replace(b.diagnosename,'，','，'))) as diagnosename 
from cdr_v_MedicalRecordMain a 
join 
(SELECT * FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) b 
on a.id = b.MedicalRecordID 
join 
(select MedicalRecordID, OperateDate, OperateCODE, OperateName, operateidx, operatedoctorname,operatefirstname FROM cdr_v_MedicalRecordOperate) c 
on a.id = c.MedicalRecordID 
join (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1) m 
on a.patientno = m.patientno 
group by m.empi, c.MedicalRecordID, a.inhospitaldeptcode, a.InHospitalDeptName, a.OutHospitalDeptName, a.OutHospitalWardName, a.EncounterID, a.patientno, a.patientname, a.inpatientnumber, to_date(a.inhospitaltime), to_date(a.outhospitaltime), to_date(c.OperateDate), c.OperateCODE, c.OperateName, c.operateidx, c.operatedoctorname, c.operatefirstname;

-- 关联患者信息 
DROP TABLE IF EXISTS skzbk.fs_INPATIENTNUMBER_LS_TEMP0;
CREATE TABLE skzbk.fs_INPATIENTNUMBER_LS_TEMP0 AS 
SELECT NVL(B.EMPI, A.patientno) AS EMPI, B.EMPI AS EMPI_OLD, A.medicalrecordid, A.inhospitaldeptcode, A.inhospitaldeptname, A.outhospitaldeptname, A.outhospitalwardname, A.encounterid, A.patientno, A.patientname, A.inpatientnumber, A.inhospitaltime, A.outhospitaltime, A.operatedate, A.operatecode, A.operatename, A.operateidx, A.operatedoctorname, A.operatefirstname, A.diagnosecode, A.diagnosename FROM skzbk.fs_medicalrecordmain_ls_temp A 
LEFT JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1) B 
ON A.patientno=B.patientno;

-- 加工唯一键，并对同一人手术按手术时间排序
DROP TABLE IF EXISTS skzbk.fs_INPATIENTNUMBER_LS_TEMP;
CREATE TABLE skzbk.fs_INPATIENTNUMBER_LS_TEMP AS
SELECT B.*, CONCAT(B.MedicalRecordID, '#', B.operateidx) AS KEY_ID, CONCAT(YEAR(B.operatedate), '-', Lpad(B.YEAR_RN, 4, '0')) AS operationnum FROM 
(select a.*, row_number() over(partition by a.empi order by a.inhospitaltime, a.operatedate, a.operateidx) as rn, row_number() over(partition by year(a.operatedate) order by a.operatedate ) as year_rn FROM skzbk.fs_INPATIENTNUMBER_LS_TEMP0 a) B;

-- 病案首页数据处理
DROP TABLE IF EXISTS skzbk.fs_MEDICALRECORDMAIN_TEMP;
CREATE TABLE skzbk.fs_MEDICALRECORDMAIN_TEMP AS
SELECT A.ID, A.PatientNo, A.RecordNumber, A.InpatientNumber, A.PatientName AS XM, A.AGE AS NL, A.ShowAge, CASE WHEN TRIM(A.SEX) IN ('1','2') THEN TRIM(A.SEX) WHEN A.IDNumber rlike '(^[1-9]\\d{5}(18|19|([23]\\d))\\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\\d{3}[0-9Xx]$)|(^[1-9]\\d{5}\\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\\d{3}$)' THEN CASE WHEN PMOD(SUBSTR(A.IDNumber, 15, 3), 2) = 1 THEN '1' WHEN PMOD(SUBSTR(A.IDNumber, 15, 3), 2) = 0 THEN '2' ELSE '0' END ELSE '0' END AS XB, TO_DATE(A.Birth) AS Birth, A.NationName, nvl(B.CODE, '99') as mz, CASE WHEN TRIM(A.Marriage) IN ('1', '2', '3', '4') THEN TRIM(A.Marriage) ELSE '9' END AS HYZK, A.IDNumber AS sfzhm, NVL(A.JobName, '') AS zy, C.wj_jobcode, A.ContactName AS LXRXM, A.ContactRelationName AS LXRGX, A.ContactTel AS LXRDH, A.ABO, CASE WHEN TRIM(A.ABO) IN ('1', '2') THEN TRIM(A.ABO) WHEN TRIM(A.ABO) = '3' THEN '4' WHEN TRIM(A.ABO) = '4' THEN '3' ELSE '5' END AS XX, A.Rh AS OLD_RH, CASE WHEN TRIM(A.Rh) = '1' THEN '2' WHEN TRIM(A.Rh) = '2' THEN '1' ELSE '3' END AS RH 
FROM cdr_V_MedicalRecordMain A 
LEFT JOIN (SELECT CODE, NAME FROM qs_wexzl_all_dic WHERE dic_type='民族字典表') B 
ON A.NationNAME = B.NAME 
LEFT JOIN WEXZL_JOB_MAPPING_DIC C 
ON TRIM(A.JobCODE)=C.cdr_jobcode;

-- 行政区域
drop table skzbk.fs_REGIONAL_LS_temp;
create table skzbk.fs_REGIONAL_LS_temp as 
select A.ID, A.PatientNo, A.RecordNumber, A.InpatientNumber, HukouProvinceCode, HukouProvinceName, HukouCityCode, HukouCityName, HukouCountyCode, HukouCountyName, HukouAddr, i.level_one_code AS level_one_code_HK, i.level_one_name AS level_one_name_HK, case when h.level_one_code = i.level_one_code then h.level_two_code end as level_two_code_HK, case when h.level_one_code = i.level_one_code then h.level_two_name end as level_two_name_HK, case when g.level_two_code = h.level_two_code and h.level_one_code = i.level_one_code then g.level_three_code when f.level_two_code = h.level_two_code and h.level_one_code = i.level_one_code then f.level_three_code end as level_three_code_HK, case when g.level_two_code = h.level_two_code and h.level_one_code = i.level_one_code then g.level_three_name when f.level_two_code = h.level_two_code and h.level_one_code = i.level_one_code then f.level_three_name end as level_three_name_HK, CurrentProvinceCode, CurrentProvinceName, CurrentCityCode, CurrentCityName, CurrentCountyCode, CurrentCountyName, e.level_one_code, e.level_one_name, case when d.level_one_code = e.level_one_code then d.level_two_code end as level_two_code, case when d.level_one_code = e.level_one_code then d.level_two_name end as level_two_name, case when c.level_two_code = d.level_two_code and d.level_one_code = e.level_one_code then c.level_three_code when b.level_two_code = d.level_two_code and d.level_one_code = e.level_one_code then b.level_three_code end as level_three_code, case when c.level_two_code = d.level_two_code and d.level_one_code = e.level_one_code then c.level_three_name when b.level_two_code = d.level_two_code and d.level_one_code = e.level_one_code then b.level_three_name end as level_three_name, CurrentAddr 
from cdr_V_MedicalRecordMain a 
left join syz_regional_dic_TEMP b 
on a.CurrentCountyCode = b.rgn_code 
and a.CurrentCountyCode is not null 
left join syz_regional_dic_TEMP c 
on a.CurrentCityCode = c.rgn_code 
and a.CurrentCityCode is not null 
left join syz_regional_dic_TEMP d 
on substr(a.CurrentCityCode, 1, 4) = d.rgn_code 
and a.CurrentCityCode is not null 
left join syz_regional_dic_TEMP e 
on substr(CurrentProvinceCode, 1, 2) = e.rgn_code 
left join syz_regional_dic_TEMP f 
on a.HukouCountyCode = f.rgn_code 
and a.HukouCountyCode is not null 
left join syz_regional_dic_TEMP g 
on a.HukouCityCode = g.rgn_code 
and a.HukouCityCode is not null 
left join syz_regional_dic_TEMP h 
on substr(a.HukouCityCode, 1, 4) = h.rgn_code 
and a.HukouCityCode is not null 
left join syz_regional_dic_TEMP i 
on substr(HukouProvinceCode, 1, 2) = i.rgn_code;

-- 关联病案首页(身份证补全，用基本信息表) 9175
DROP TABLE IF EXISTS skzbk.fs_INPATIENTNUMBER_FIRST;
CREATE TABLE skzbk.fs_INPATIENTNUMBER_FIRST AS 
SELECT DISTINCT A.EMPI, A.patientno, A.inpatientnumber, A.InHospitalTime, A.OutHospitalTime, A.InHospitalDeptCode, A.InHospitalDeptname, A.OutHospitalDeptName, A.OutHospitalWardName, A.diagnosecode, A.diagnosename, A.OperateDate, A.RN AS OperateIdx, A.OperateCode, A.OperateName, C.XM AS NAME, replace(C.NL,'岁','') AS AGE,  C.XB AS SEX, C.Birth AS BIRTHDAY, NVL(NVL(C.SFZHM,B.IDNo),'') AS IDCARD, NVL(C.LXRXM,'') AS CONTACTNAME, NVL(C.LXRGX,'') AS CONTACTRELATION, NVL(C.LXRDH,'') AS CONTACTTEL, C.MZ AS NATION, C.wj_jobcode AS JOB, C.HYZK AS MARRIAGE, C.XX, C.RH, NVL(D.HukouAddr,'') AS hJzzxxdz, NVL(D.level_one_code_hk,'') AS hJzzsdm, NVL(D.level_one_name_hk,'') AS hJzzs, NVL(D.level_two_code_hk,'') AS hJzzshidm, NVL(D.level_two_name_hk,'') AS hJzzshi, NVL(D.level_three_code_hk,'') AS hJzzxdm, NVL(D.level_three_name_hk,'') AS hJzzx, NVL(D.CurrentAddr,'') AS jtzzxxdz, NVL(D.level_one_code,'') AS jtzzsdm, NVL(D.level_one_name,'') AS jtzzs, NVL(D.level_two_code,'') AS jtzzshidm, NVL(D.level_two_name,'') AS jtzzshi, NVL(D.level_three_code,'') AS jtzzxdm, NVL(D.level_three_name,'') AS jtzzx 
FROM (SELECT * FROM skzbk.fs_INPATIENTNUMBER_LS_TEMP WHERE RN=1) A 
LEFT JOIN cdr_v_PatientBasicInformation B 
ON A.EMPI=B.EMPI 
JOIN skzbk.fs_MEDICALRECORDMAIN_TEMP C 
ON A.MedicalRecordID=C.id 
JOIN skzbk.fs_REGIONAL_LS_temp D 
ON C.ID=D.ID;

DROP TABLE IF EXISTS skzbk.fs_INPATIENTNUMBER_LS;
CREATE TABLE skzbk.fs_INPATIENTNUMBER_LS AS 
SELECT CONCAT(YEAR(B.operatedate),'-',Lpad(B.YEAR_RN,4,'0')) AS patient_num, B.* 
FROM (SELECT A.*, ROW_NUMBER() OVER(PARTITION BY YEAR(A.operatedate) ORDER BY A.operatedate, A.InHospitalTime, A.inpatientnumber) AS YEAR_RN FROM skzbk.fs_INPATIENTNUMBER_FIRST A) B;

-- qs_drz_patient脱敏
SELECT A.patient_num as patient_num, A.EMPI as empi, A.inpatientnumber as inpatient_number, A.patientno as patient_no, CONCAT(SUBSTRING(A.name, 1, 1), '三', SUBSTRING(A.name, 3, LENGTH(A.name)-2)) as name, CONCAT('***', SUBSTRING(A.idcard, 4, length(A.idcard)-7), '0000') as id_card, CASE WHEN A.SEX='1' THEN '男' WHEN A.SEX='2' THEN '女' ELSE '未知' END as sex, A.age as age, 1 as hospital_id, '42502657200' as hospital_code, 1 as group_id, A.inhospitaltime as in_hospital_datetime, A.outhospitaltime as out_hospital_datetime, A.InHospitalDeptCode as in_hospital_dept_code, A.InHospitalDeptName as in_hospital_dept_name, A.OutHospitalDeptName as out_hospital_dept_name, A.OutHospitalWardName as out_hospital_ward_name, A.diagnosecode as primary_diagnosis_code, A.diagnosename as primary_diagnosis, A.OperateDate as operate_date, A.OperateCode as operate_code, A.OperateName as operate_name, '0' AS delete_flag, '0' AS source_flag, A.operateidx as operate_idx, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd') AS create_date 
FROM skzbk.fs_INPATIENTNUMBER_LS A;

-- qs_drz_patient不脱敏
SELECT A.patient_num as patient_num, A.EMPI as empi, A.inpatientnumber as inpatient_number, A.patientno as patient_no, A.name as name, A.idcard as id_card, CASE WHEN A.SEX='1' THEN '男' WHEN A.SEX='2' THEN '女' ELSE '未知' END as sex, A.age as age, 1 as hospital_id, '42502657200' as hospital_code, 1 as group_id, A.inhospitaltime as in_hospital_datetime, A.outhospitaltime as out_hospital_datetime, A.InHospitalDeptCode as in_hospital_dept_code, A.InHospitalDeptName as in_hospital_dept_name, A.OutHospitalDeptName as out_hospital_dept_name, A.OutHospitalWardName as ward, A.diagnosecode as primary_diagnosis_code, A.diagnosename as primary_diagnosis, A.OperateDate as operate_date, A.OperateCode as operate_code, A.OperateName as operate_name, '0' AS delete_flag, '0' AS source_flag, A.operateidx as operate_idx, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd') AS create_date 
FROM skzbk.fs_INPATIENTNUMBER_LS A;

-- form_basic_info脱敏
SELECT * FROM 
(SELECT g.*, row_number() over (partition by g.empi order by g.in_hospital_time desc) num FROM
(select distinct a.PatientNo as patient_no, NVL(i.EMPI, i.patientno) AS EMPI, a.EncounterID as encounter_id, CONCAT(SUBSTRING(a.PatientName, 1, 1), '三', SUBSTRING(a.PatientName, 3, LENGTH(a.PatientName)-2)) as patient_name, a.Sex as sex, a.countryname as countryname, a.nationname as nationname, a.birth as birth, a.InHospitalTime as in_hospital_time, a.OutHospitalTime as out_hospital_time, CONCAT('***', SUBSTRING(a.IDNumber, 4, length(a.IDNumber)-7), '0000') as id_number, a.marriage as marriage, a.jobname as jobname, a.birthprovincename as birth_sheng, a.birthprovincecode as birth_sheng_code, a.birthcityname as birth_shi, a.birthcitycode as birth_shi_code, a.birthcountyname as birth_qu, a.birthcountycode as birth_qu_code, a.NativeProvinceName as native_sheng, a.NativeProvinceCode as native_sheng_code, a.NativeCityName as native_shi, a.NativeCityCode as native_shi_code, a.CurrentProvinceCode as current_province_code, a.CurrentProvinceName as current_province_name, a.CurrentCityCode as current_city_code, a.CurrentCityName as current_city_name, a.CurrentCountyCode as current_county_code, a.CurrentCountyName as current_county_name, a.CurrentAddr as current_addr, CONCAT(SUBSTRING(a.contacttel, 1, 3), '***00000') as contact_tel, CONCAT(SUBSTRING(a.CurrentTel, 1, 3), '***00000') as by_tel, a.abo as blood_abo, a.rh as blood_rh, a.payway as payway, '42502657200' as hospital_code, a.InpatientNumber as inpatient_number, a.OutpatientNumber as outpatient_number, CONCAT(SUBSTRING(b.contactphone, 1, 3), '***00000') as contactphone, 0 as delete_flag, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date 
from (SELECT * FROM cdr_v_MedicalRecordMain where id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+'))) a 
left join cdr_V_PatientBasicInformation b 
on a.PatientNo=b.PatientNo 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1) i 
ON a.PatientNo=i.PatientNo 
where a.PatientNo in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) g) h 
WHERE h.num = 1;

-- form_basic_info不脱敏
SELECT * FROM 
(SELECT g.*, row_number() over (partition by g.empi order by g.in_hospital_time desc) num FROM
(select distinct a.PatientNo as patient_no, NVL(i.EMPI, i.patientno) AS EMPI, a.EncounterID as encounter_id, a.PatientName as patient_name, a.Sex as sex, a.countryname as countryname, a.nationname as nationname, a.birth as birth, a.InHospitalTime as in_hospital_time, a.OutHospitalTime as out_hospital_time, a.IDNumber as id_number, a.marriage as marriage, a.jobname as jobname, a.birthprovincename as birth_sheng, a.birthprovincecode as birth_sheng_code, a.birthcityname as birth_shi, a.birthcitycode as birth_shi_code, a.birthcountyname as birth_qu, a.birthcountycode as birth_qu_code, a.NativeProvinceName as native_sheng, a.NativeProvinceCode as native_sheng_code, a.NativeCityName as native_shi, a.NativeCityCode as native_shi_code, a.CurrentProvinceCode as current_province_code, a.CurrentProvinceName as current_province_name, a.CurrentCityCode as current_city_code, a.CurrentCityName as current_city_name, a.CurrentCountyCode as current_county_code, a.CurrentCountyName as current_county_name, a.CurrentAddr as current_addr, a.contacttel as contact_tel, a.CurrentTel as by_tel, a.abo as blood_abo, a.rh as blood_rh, a.payway as payway, '42502657200' as hospital_code, a.InpatientNumber as inpatient_number, a.OutpatientNumber as outpatient_number, b.contactphone as contactphone, 0 as delete_flag, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date 
from (SELECT * FROM cdr_v_MedicalRecordMain where id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+'))) a 
left join cdr_V_PatientBasicInformation b
on a.PatientNo=b.PatientNo 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1) i 
ON a.PatientNo=i.PatientNo 
where a.PatientNo in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) g) h 
WHERE h.num = 1;

# 住院记录qs_admission_history
SELECT c.*, ROW_NUMBER() OVER(PARTITION BY c.empi ORDER BY c.in_hospital_date) AS admission_num FROM 
(SELECT distinct NVL(b.EMPI, a.PatientNo) AS EMPI, a.PatientNo as patient_no, a.inpatientnumber as inpatient_number, a.inhospitaltime as in_hospital_date, a.outhospitaltime as out_hospital_date, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date 
FROM cdr_V_MedicalRecordMain a 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) b 
ON a.PatientNo=b.PatientNo 
WHERE a.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+'))) c;

-- form_diagnose_info
select distinct NVL(c.EMPI, c.patientno) AS EMPI, a.PatientNo as patient_no, a.encounterid as encounter_id, CONCAT(SUBSTRING(a.PatientName, 1, 1), '三', SUBSTRING(a.PatientName, 3, LENGTH(a.PatientName)-2)) as patient_name, replace(a.age, '岁', '') as age, a.inpatientnumber as inpatient_number, a.outpatientnumber as outpatient_number, a.inhospitaltime as in_hospital_time, a.outhospitaltime as out_hospital_time, a.payway as pay_way, a.dietime as die_time, CASE WHEN a.dietime is not NULL THEN 1 ELSE 0 END as is_die, a.inhospitalwardcode as inhospital_ward_code, a.inhospitalwardname as inhospital_ward_name, a.inhospitalbedcode as inhospital_bed_code, a.inhospitaldeptcode as inhospital_dept_code, a.inhospitaldeptname as inhospital_dept_name, a.inhospitalway as inhospital_way, a.outhospitaldeptcode as outhospital_dept_code, a.outhospitaldeptname as outhospital_dept_name, a.inhospitaltotalcost as inhospital_total_cost, a.inpatienttimes as inpatient_times, b.isprimary as isprimary, b.diagnosecode as diagnose_code, b.diagnosename as diagnose_name, '42502657200' as hospital_code, 0 as delete_flag, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date 
from cdr_v_MedicalRecordMain a 
left join (SELECT * FROM cdr_v_PATIENTDIAGNOSIS WHERE diagnosetype = 2) b 
ON a.patientno = b.patientno and a.encounterid = b.encounterid 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1) c 
ON a.PatientNo = c.PatientNo 
WHERE a.PatientNo in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp) AND TRIM(b.DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+');

-- form_diagnose_detail
select distinct NVL(c.EMPI, c.patientno) AS EMPI, a.PatientNo as patient_no, a.encounterid as encounter_id, CONCAT(SUBSTRING(a.PatientName, 1, 1), '三', SUBSTRING(a.PatientName, 3, LENGTH(a.PatientName)-2)) as patient_name, a.inhospitaltime as inhospital_time, a.outhospitaltime as outhospital_time, a.inpatientnumber as inpatient_number, a.outpatientnumber as outpatient_number, b.diagnosetime as diagnose_time, substr(b.diagnosetime, 0, 10) as diagnose_time_var, b.isprimary as isprimary, b.diagnosecode as diagnose_code, b.diagnosename as diagnose_name, '42502657200' as hospital_code, 0 as delete_flag, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date 
from cdr_v_MedicalRecordMain a 
JOIN cdr_v_PATIENTDIAGNOSIS b 
ON a.patientno = b.patientno and a.encounterid = b.encounterid 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1) c 
ON a.PatientNo = c.PatientNo 
WHERE a.PatientNo in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp) AND (TRIM(b.DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) AND b.diagnosetype = 2;

# form_operation_info
SELECT distinct NVL(d.EMPI, d.PatientNo) AS EMPI, a.PatientNo as patient_no, a.encounterid as encounter_id, a.inpatientnumber as inpatient_number, a.inhospitaltime as in_hospital_datetime, a.outhospitaltime as out_hospital_datetime, b.operatedate as operate_date, b.operatecode as operate_code, b.operatename as operate_name, c.operationdeptnname as operation_dept_name, b.operatedoctorname as operate_doctor_name, b.anesthesiawaycode as anesthesia_way_code, b.anesthesiawayname as anesthesia_way_name, b.anesthesiadoctorname as anesthesia_doctor_name, c.preoperationdiagnosecode as preoperation_diagnose_code, c.preoperationdiagnosename as preoperation_diagnose_name, '42502657200' as hospital_code, 0 as delete_flag, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date 
FROM cdr_V_MedicalRecordMain a 
JOIN cdr_V_MEDICALRECORDOPERATE b 
ON a.id = b.medicalrecordid 
LEFT JOIN (SELECT * FROM cdr_V_OPERATIONRECORD WHERE bigdata_data_tag = 1) c 
ON a.patientno = c.patientno AND a.encounterid = c.Inpatientvisitid AND b.operatedate = c.operationtime 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) d 
ON a.PatientNo = d.PatientNo 
WHERE a.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+'));

# form_medication_info
SELECT NVL(d.EMPI, d.patientno) AS EMPI, c.PatientNo as patient_no, c.EncounterID as encounter_id, c.InpatientNumber as inpatient_number, c.OutpatientNumber as outpatient_number, c.InHospitalTime as in_hospital_time, c.OutHospitalTime as out_hospital_time, a.MasterOrdersID as master_orders_id, a.OrdersCode as orders_code, case when a.OrdersName = '(甲)重组人胰岛素注射液(优泌林R)笔芯' then '(甲)重组人胰岛素注射液(优泌林R笔芯)' when a.OrdersName = '(乙10%)重组牛碱性成纤维细胞生长因子外用溶液(贝复济' then '(乙10%)重组牛碱性成纤维细胞生长因子外用溶液(贝复济)' when a.OrdersName LIKE '%（%' then replace(a.OrdersName, '（', '(') when a.OrdersName LIKE '%）%' then replace(a.OrdersName, '）', ')') else a.OrdersName end as orders_name, a.Specifications as specifications, a.Dosage as dosage, a.DosageUnit as dosage_unit, a.Pathway as pathway, a.Frequency as frequency, a.frequency as pc, a.WriteRecipeTime as write_recipe_time, a.ProjectTypeCode as project_type_code, a.ProjectTypeName as project_type_name, a.ordersstarttime as orders_start_time, a.stoptime as stop_time, a.solventflag as solventflag, a.remark as remark, '42502657200' as hospital_code, 0 as delete_flag, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date 
FROM cdr_V_MedicationOrders a -- 住院用药医嘱（MedicationOrders）
JOIN cdr_V_MedicalRecordMain c -- 病案首页（MedicalRecordMain）
ON a.inpatientvisitid = c.encounterid 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) d
ON a.PatientNo = d.PatientNo 
LEFT JOIN skzbk.dict_frequency e 
ON a.Frequency=e.code 
WHERE c.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) and a.OrdersCode in ('100438','100439','100440','100441','100443','100444','100546','121153','124600','100070','121390','100598','100854','100855','100856','100857','100858','100865','100871','100875','100877','100878','112192','121229','121298','122968','122973','122998','124685','100548','100549','100550','100551','100552','100599','100601','100646','100867','100873','100874','101163','101310','102947','112249','121403','122991','124612','100001','100006','100007','100008','100009','100014','100016','100017','100030','100038','100039','100050','100051','100055','100056','100059','100063','100066','100073','100079','100086','100115','100116','100119','100122','100124','100301','100370','100885','100886','100887','112212','112258','121122','121130','121135','121246','121273','121305','121348','121365','121446','121450','121452','121454','121456','121457','121462','121466','122993','122994','123884','124624','124687','124692','124697','124802','124804','100520','100521','100515','100518','100638','100650','100677','102938','121242','124767','121468','122992','100203','100214','100218','121397','100171','100176','100177','100198','100200','100233','100242','100246','100247','100248','100249','100250','100252','100259','100264','100265','100267','100268','100270','102939','112245','121099','121119','121141','121156','121300','121301','121307','121309','121367','121453','121465','122995','123864','124691','124693','124701','124707','100567','100570','100572','100576','100950','100956','100957','102943','121187','121210','121213','121399','121451','121455','122979','122997','124698','124703','124706','100222','100225','100229','121255','121299','121352','121444','121469','122974','124801','100144','100157','100158','100159','100160','100161','100163','100206','100207','100883','100884','112272','121149','121150','121236','121294','121319','121320','121346','122976','100962','100964','100966','100978','121270','100308','100310','100311','100313','100315','100317','100318','100340','100342','112233','121176','121232','121252','121381','121458','122988','124681','124688','100635','100106','100133','100137','100143','100148','100153','100169','100191','100192','100201','100205','100208','100266','100271','100283','100285','100289','100291','100293','100294','100295','100302','100327','100334','100337','100346','100353','100359','100367','100368','100375','100376','100401','100402','100429','100456','100464','100467','100473','100488','100490','100497','100506','100525','100529','100534','100580','100583','100585','100587','100597','100684','100716','100723','100732','100733','100745','100747','100749','100750','100752','100761','100764','100766','100767','100768','100769','100770','100772','100774','100827','100828','100842','100851','100889','100890','100892','100899','100904','100924','100926','100933','100938','100953','100969','100970','100981','100985','100986','100987','100994','100997','101000','101007','101014','101027','101028','101057','101076','101089','101090','101091','101093','101102','101103','101104','101106','101162','101164','101166','101168','101170','101323','101328','102946','112143','112215','112216','112274','112281','112282','121091','121114','121124','121136','121157','121159','121166','121202','121207','121221','121230','121233','121245','121260','121264','121272','121303','121304','121312','121327','121353','121354','121377','121378','121388','121389','121394','121412','121421','121445','121459','121460','121470','122316','122317','122944','122966','122969','122972','122975','122977','122978','122980','122982','122983','122985','122987','124602','124643','124645','124657','124671','124680','124684','124686','124695','124702','124749','124759','124761','124787','100882','121158','100738','100739','100810','100815','121310','100658','101033','101036','112236','121133','121383','122344','100180','100182','100186','100074','100075','100078','100091','100093','100381','100382','100394','100398','100400','100403','100404','100409','100411','100412','100421','100422','100424','100426','100428','100430','100431','100433','100434','100537','100864','101260','101277','101329','102934','102940','121103','121173','121361','121375','122984','123855','123888','124705','124724','100071','100164','100173','100185','100876','100975','101173','101176','101181','101186','101187','101190','101209','101210','101214','101227','101231','101244','101247','101279','101295','101296','101302','101317','101320','121123','121431','121432','121474','122943','122952');

# form_herbal_medication_info
SELECT NVL(d.EMPI, d.id) AS EMPI, c.PatientNo as patient_no, c.EncounterID as encounter_id, c.InpatientNumber as inpatient_number, c.OutpatientNumber as outpatient_number, c.InHospitalTime as in_hospital_time, a.medicationordersid as medicationordersid, a.OrdersCode as orders_code, a.OrdersName as orders_name, a.ordersattributeid as ordersattributeid, a.specifications as specifications, a.dosage as dosage, a.dosageunit as dosageunit, a.frequency as frequency, a.pathway as pathway, a.method as method, a.medicationnum as medicationnum, a.ordersstarttime as ordersstarttime, a.ordersstoptime as ordersstoptime 
FROM cdr_V_HERBALMEDICATIONORDERS a 
JOIN cdr_V_MedicalRecordMain c 
ON a.PatientNo = c.PatientNo
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) d 
ON a.PatientNo = d.PatientNo 
WHERE c.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+'));

-- form_physical_exam_info
SELECT NVL(r.EMPI, r.PatientNo) AS EMPI, a.PatientNo as patient_no, CONCAT('***', SUBSTRING(a.IDNumber, 4, length(a.IDNumber)-7), '0000') as id_number, a.EncounterID as encounter_id, a.InpatientNumber as inpatient_number, a.OutpatientNumber as outpatient_number, c.operatedate as operate_date, substr(c.operatedate, 0, 10) as operate_date_var, c.Value as height, e.Value as weight, g.Value as temperature, CASE WHEN i.Value IS NOT NULL THEN split(i.Value, '/')[0] ELSE NULL END as systolic, CASE WHEN i.Value IS NOT NULL THEN split(i.Value, '/')[1] ELSE NULL END as diastolic, m.Value as respiratory_rate, o.Value as heart_rate, q.Value as oxygen_saturation, '42502657200' as hospital_code, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date 
FROM cdr_V_MedicalRecordMain a 
LEFT JOIN 
(select * from (SELECT patientno, encounterid, operatedate, Value, row_number() over (partition by patientno, encounterid order by operatedate desc) rank FROM cdr_v_PATIENTVITALSIGN WHERE VitalSignId='3024' AND Value>=50 AND Value<=250) b WHERE b.rank = 1) c -- 身高
ON a.PatientNo = c.PatientNo and a.encounterid = c.encounterid 
LEFT JOIN 
(select * from (SELECT patientno, encounterid, operatedate, Value, row_number() over (partition by patientno, encounterid order by operatedate desc) rank FROM cdr_v_PATIENTVITALSIGN WHERE VitalSignId='1014' AND Value>=20 AND Value<=200) d WHERE d.rank = 1) e -- 体重 
ON a.PatientNo = e.PatientNo and a.encounterid = e.encounterid 
LEFT JOIN 
(select * from (SELECT patientno, encounterid, operatedate, Value, row_number() over (partition by patientno, encounterid order by operatedate desc) rank FROM cdr_v_PATIENTVITALSIGN WHERE VitalSignId='1001' AND Value>=33 AND Value<=43) f WHERE f.rank = 1) g -- 体温 
ON a.PatientNo = g.PatientNo and a.encounterid = g.encounterid 
LEFT JOIN 
(select * from (SELECT patientno, encounterid, operatedate, Value, row_number() over (partition by patientno, encounterid order by operatedate desc) rank FROM cdr_v_PATIENTVITALSIGN WHERE VitalSignId='128') h WHERE h.rank = 1) i -- 收缩压 
ON a.PatientNo = i.PatientNo and a.encounterid = i.encounterid 
LEFT JOIN 
(select * from (SELECT patientno, encounterid, operatedate, Value, row_number() over (partition by patientno, encounterid order by operatedate desc) rank FROM cdr_v_PATIENTVITALSIGN WHERE VitalSignId='1004' AND Value>=20 AND Value<=200) l WHERE l.rank = 1) m -- 呼吸频率 
ON a.PatientNo = m.PatientNo and a.encounterid = m.encounterid 
LEFT JOIN 
(select * from (SELECT patientno, encounterid, operatedate, Value, row_number() over (partition by patientno, encounterid order by operatedate desc) rank FROM cdr_v_PATIENTVITALSIGN WHERE VitalSignId='113' AND Value>=30 AND Value<=200) n WHERE n.rank = 1) o -- 心率 
ON a.PatientNo = o.PatientNo and a.encounterid = o.encounterid 
LEFT JOIN 
(select * from (SELECT patientno, encounterid, operatedate, Value, row_number() over (partition by patientno, encounterid order by operatedate desc) rank FROM cdr_v_PATIENTVITALSIGN WHERE VitalSignId='129' AND Value>=30 AND Value<=200) p WHERE p.rank = 1) q -- 氧饱和度 
ON a.PatientNo = q.PatientNo and a.encounterid = q.encounterid 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) r 
ON a.PatientNo = r.PatientNo 
where a.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+'));

-- 心动图骨密度
SELECT distinct NVL(f.EMPI, f.PatientNo) AS EMPI, c.PatientNo as patient_no, CONCAT('***', SUBSTRING(e.IDNumber, 4, length(e.IDNumber)-7), '0000') as id_number, c.EncounterID as encounter_id, e.InpatientNumber as inpatient_number, e.OutpatientNumber as outpatient_number, c.EncounterType as encounter_type, CASE WHEN a.inspectionprojectname LIKE '%骨密度%' THEN 25 ELSE 21 end as question_id, d.ReportID as report_id, c.TSExam as ts_exam, substr(c.TSExam, 0, 10) as ts_exam_var, d.examName as exam_name, c.ReportName as report_name, d.ExamFind as exam_find, d.ExamConclusion as exam_conclusion, d.BodySite as body_site, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date, c.reportclasscode as report_class_code, c.reportclassname as report_class_name, a.inspectionprojectname as inspection_project_name, a.inspectionprojectname as inspection_project_name 
FROM cdr_V_INSPECTIONSHEETDETAIL a 
JOIN cdr_V_INSPECTIONSHEETREPORT b 
ON a.sheetid = b.sheetid and a.sheetno = b.sheetno 
JOIN cdr_V_OTHERREPORT c -- B超报告（UltrasoundReport）
ON b.reportid = c.id 
JOIN cdr_V_OTHERRESULT d -- B超报告项目结果（UltrasoundResult）
ON c.id = d.ReportID 
JOIN cdr_V_MedicalRecordMain e -- 病案首页（MedicalRecordMain）
ON c.PatientNo = e.PatientNo 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) f 
ON c.PatientNo = f.PatientNo and c.encounterid = e.encounterid 
WHERE e.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) AND (b.inspectionprojectname LIKE '%骨密度%' or b.inspectionprojectname LIKE '%超声心动图%');

SELECT * 
FROM cdr_V_OTHERREPORT a -- B超报告（UltrasoundReport）
JOIN cdr_V_OTHERRESULT b -- B超报告项目结果（UltrasoundResult）
ON a.id = b.ReportID 
LEFT JOIN cdr_V_INSPECTIONSHEETREPORT c 
ON b.reportid = c.reportid 
LEFT JOIN cdr_V_INSPECTIONSHEETDETAIL d 
ON c.sheetid = d.sheetid and c.sheetno = d.sheetno 
JOIN cdr_V_MedicalRecordMain e -- 病案首页（MedicalRecordMain）
ON a.PatientNo = e.PatientNo and a.encounterid = e.encounterid 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) f 
ON a.PatientNo = f.PatientNo 
WHERE e.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+'));

-- 血常规
SELECT NVL(d.EMPI, d.PatientNo) AS EMPI, c.PatientNo as patient_no, CONCAT('***', SUBSTRING(c.IDNumber, 4, length(c.IDNumber)-7), '0000') as id_number, c.EncounterID as encounter_id, a.EncounterType as encounter_type, c.InpatientNumber as inpatient_number, c.OutpatientNumber as outpatient_number, 27 as question_id, b.LabGenericID as lab_generic_id, a.TSTest as ts_test, substr(a.TSTest, 0, 10) as ts_test_var, a.SpecimenClassName, b.TestItemName as table_item_name, b.TestItemCode as test_item_code, b.TestItemName as test_item_name, b.PrintValue as print_value, b.ResultValue as result_value, b.ResultUnit as result_unit, b.ReferenceText as reference_text, b.AbnormalFlag as abnormal_flag, b.AbnormalFlagName as abnormal_flag_name, '42502657200' as hospital_code, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date , a.tsdraw as ts_draw, substr(a.tsdraw, 0, 10) as ts_draw_var
FROM cdr_V_LabGenericReport a 
JOIN cdr_V_LabGenericResult b 
ON a.id = b.LabGenericID 
JOIN cdr_V_MedicalRecordMain c 
ON a.PatientNo = c.PatientNo and a.Encounterid = c.EncounterID 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) d 
ON c.PatientNo = d.PatientNo 
where c.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) and (b.TestItemName = '白细胞计数' or b.TestItemName = '红细胞计数' or b.TestItemName = '血红蛋白' or b.TestItemName = '血小板计数' or b.TestItemName = '嗜中性粒细胞绝对值' or b.TestItemName = '淋巴细胞绝对值' or b.TestItemName = '单核细胞绝对值' or b.TestItemName = '网织红细胞比率');

-- 尿常规
SELECT NVL(d.EMPI, d.PatientNo) AS EMPI, c.PatientNo as patient_no, CONCAT('***', SUBSTRING(c.IDNumber, 4, length(c.IDNumber)-7), '0000') as id_number, c.EncounterID as encounter_id, a.EncounterType as encounter_type, c.InpatientNumber as inpatient_number, c.OutpatientNumber as outpatient_number, 28 as question_id, b.LabGenericID as lab_generic_id, a.TSTest as ts_test, substr(a.TSTest, 0, 10) as ts_test_var, a.SpecimenClassName, b.TestItemName as table_item_name, b.TestItemCode as test_item_code, b.TestItemName as test_item_name, b.PrintValue as print_value, b.ResultValue as result_value, b.ResultUnit as result_unit, b.ReferenceText as reference_text, b.AbnormalFlag as abnormal_flag, b.AbnormalFlagName as abnormal_flag_name, '42502657200' as hospital_code, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date , a.tsdraw as ts_draw, substr(a.tsdraw, 0, 10) as ts_draw_var
FROM cdr_V_LabGenericReport a 
JOIN cdr_V_LabGenericResult b 
ON a.id = b.LabGenericID 
JOIN cdr_V_MedicalRecordMain c 
ON a.PatientNo = c.PatientNo and a.Encounterid = c.EncounterID 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) d 
ON c.PatientNo = d.PatientNo 
where c.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) and (b.TestItemName = '尿比重' or b.TestItemName = '尿酸碱度' or b.TestItemName = '尿蛋白质' or b.TestItemName = '尿沉渣红细胞计数' or b.TestItemName = '尿沉渣白细胞计数' or b.TestItemName = '镜检红细胞' or b.TestItemName = '镜检白细胞' or b.TestItemName = '镜检管型') and a.SpecimenClassName LIKE '%尿%';

-- 尿蛋白定量
SELECT NVL(d.EMPI, d.PatientNo) AS EMPI, c.PatientNo as patient_no, CONCAT('***', SUBSTRING(c.IDNumber, 4, length(c.IDNumber)-7), '0000') as id_number, c.EncounterID as encounter_id, a.EncounterType as encounter_type, c.InpatientNumber as inpatient_number, c.OutpatientNumber as outpatient_number, 29 as question_id, b.LabGenericID as lab_generic_id, a.TSTest as ts_test, substr(a.TSTest, 0, 10) as ts_test_var, a.SpecimenClassName, CASE WHEN b.TestItemName = '尿总蛋白肌酐比' then '尿总蛋白/肌酐比' WHEN b.TestItemName = '尿白蛋白/肌酐比值' then '尿白蛋白/肌酐比' WHEN b.TestItemName = '尿白蛋白肌酐比' then '尿白蛋白/肌酐比' else b.TestItemName end as table_item_name, b.TestItemCode as test_item_code, b.TestItemName as test_item_name, b.PrintValue as print_value, b.ResultValue as result_value, b.ResultUnit as result_unit, b.ReferenceText as reference_text, b.AbnormalFlag as abnormal_flag, b.AbnormalFlagName as abnormal_flag_name, '42502657200' as hospital_code, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date , a.tsdraw as ts_draw, substr(a.tsdraw, 0, 10) as ts_draw_varFROM cdr_V_LabGenericReport a 
JOIN cdr_V_LabGenericResult b 
ON a.id = b.LabGenericID 
JOIN cdr_V_MedicalRecordMain c 
ON a.PatientNo = c.PatientNo and a.Encounterid = c.EncounterID 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) d 
ON c.PatientNo = d.PatientNo 
where c.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) and ((b.TestItemName = '尿蛋白定量' and a.SpecimenClassName LIKE '%尿%') or b.TestItemName = '尿总蛋白肌酐比' or b.TestItemName = '尿白蛋白/肌酐比值' or b.TestItemName = '尿白蛋白肌酐比');

-- 脑脊液检查
SELECT NVL(d.EMPI, d.PatientNo) AS EMPI, c.PatientNo as patient_no, CONCAT('***', SUBSTRING(c.IDNumber, 4, length(c.IDNumber)-7), '0000') as id_number, c.EncounterID as encounter_id, a.EncounterType as encounter_type, c.InpatientNumber as inpatient_number, c.OutpatientNumber as outpatient_number, 30 as question_id, b.LabGenericID as lab_generic_id, a.TSTest as ts_test, substr(a.TSTest, 0, 10) as ts_test_var, a.SpecimenClassName, CASE WHEN b.TestItemName = '潘氏试验(脑脊液)' then '脑脊液常规 - 潘氏试验' WHEN b.TestItemName = '潘式试验（脑脊液）' then '脑脊液常规 - 潘氏试验' WHEN b.TestItemName = '脑脊液白细胞数' then '脑脊液常规 - 白细胞计数' WHEN b.TestItemName = '白细胞数(脑脊液)' then '脑脊液常规 - 白细胞计数' else b.TestItemName end as table_item_name, b.TestItemCode as test_item_code, b.TestItemName as test_item_name, b.PrintValue as print_value, b.ResultValue as result_value, b.ResultUnit as result_unit, b.ReferenceText as reference_text, b.AbnormalFlag as abnormal_flag, b.AbnormalFlagName as abnormal_flag_name, '42502657200' as hospital_code, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date , a.tsdraw as ts_draw, substr(a.tsdraw, 0, 10) as ts_draw_varFROM cdr_V_LabGenericReport a 
JOIN cdr_V_LabGenericResult b 
ON a.id = b.LabGenericID 
JOIN cdr_V_MedicalRecordMain c 
ON a.PatientNo = c.PatientNo and a.Encounterid = c.EncounterID 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) d 
ON c.PatientNo = d.PatientNo 
where c.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) and (b.TestItemName = '潘氏试验(脑脊液)' or b.TestItemName = '潘式试验（脑脊液）' or b.TestItemName = '脑脊液常规 - 红细胞计数' or b.TestItemName = '脑脊液白细胞数' or b.TestItemName = '白细胞数(脑脊液)' or b.TestItemName = '脑脊液蛋白定量' or b.TestItemName = '脑脊液糖定量' or b.TestItemName = '脑脊液氯化物' or b.TestItemName = '腺苷脱氨酶');

-- 出凝血相关
SELECT NVL(d.EMPI, d.PatientNo) AS EMPI, c.PatientNo as patient_no, CONCAT('***', SUBSTRING(c.IDNumber, 4, length(c.IDNumber)-7), '0000') as id_number, c.EncounterID as encounter_id, a.EncounterType as encounter_type, c.InpatientNumber as inpatient_number, c.OutpatientNumber as outpatient_number, 31 as question_id, b.LabGenericID as lab_generic_id, a.TSTest as ts_test, substr(a.TSTest, 0, 10) as ts_test_var, a.SpecimenClassName, CASE WHEN b.TestItemName = '纤维蛋白（原）降解物' then '纤维蛋白(原)降解产物' WHEN b.TestItemName = '纤维蛋白(原)降解物' then '纤维蛋白(原)降解产物' else b.TestItemName end as table_item_name, b.TestItemCode as test_item_code, b.TestItemName as test_item_name, b.PrintValue as print_value, b.ResultValue as result_value, b.ResultUnit as result_unit, b.ReferenceText as reference_text, b.AbnormalFlag as abnormal_flag, b.AbnormalFlagName as abnormal_flag_name, '42502657200' as hospital_code, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date , a.tsdraw as ts_draw, substr(a.tsdraw, 0, 10) as ts_draw_var
FROM cdr_V_LabGenericReport a 
JOIN cdr_V_LabGenericResult b 
ON a.id = b.LabGenericID 
JOIN cdr_V_MedicalRecordMain c 
ON a.PatientNo = c.PatientNo and a.Encounterid = c.EncounterID 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) d 
ON c.PatientNo = d.PatientNo 
where c.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) and (b.TestItemName = '凝血酶原时间' or b.TestItemName = '国际标准化比率' or b.TestItemName = '部分凝血活酶时间' or b.TestItemName = '纤维蛋白原' or b.TestItemName = 'D-D二聚体' or b.TestItemName = '纤维蛋白(原)降解物' or b.TestItemName = '纤维蛋白（原）降解物');

-- 血生化和电解质
SELECT NVL(d.EMPI, d.PatientNo) AS EMPI, c.PatientNo as patient_no, CONCAT('***', SUBSTRING(c.IDNumber, 4, length(c.IDNumber)-7), '0000') as id_number, c.EncounterID as encounter_id, a.EncounterType as encounter_type, c.InpatientNumber as inpatient_number, c.OutpatientNumber as outpatient_number, 32 as question_id, b.LabGenericID as lab_generic_id, a.TSTest as ts_test, substr(a.TSTest, 0, 10) as ts_test_var, a.SpecimenClassName, CASE WHEN b.TestItemName = 'γ谷氨酰基转移酶' then 'γ谷氨酰转肽酶' WHEN b.TestItemName = 'γ-谷氨酰转肽酶' then 'γ谷氨酰转肽酶' WHEN b.TestItemName = '肌酸激酶（CK-MB）' then '肌酸激酶' WHEN b.TestItemName = '糖化血红蛋白-A1c' then '糖化血红蛋白' WHEN b.TestItemName = '25-羟基维生素D' then '25-羟基维生素D(VITD)' WHEN b.TestItemName = '甘油三脂' then '甘油三酯' else b.TestItemName end as table_item_name, b.TestItemCode as test_item_code, b.TestItemName as test_item_name, b.PrintValue as print_value, b.ResultValue as result_value, b.ResultUnit as result_unit, b.ReferenceText as reference_text, b.AbnormalFlag as abnormal_flag, b.AbnormalFlagName as abnormal_flag_name, '42502657200' as hospital_code, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date , a.tsdraw as ts_draw, substr(a.tsdraw, 0, 10) as ts_draw_var
FROM cdr_V_LabGenericReport a 
JOIN cdr_V_LabGenericResult b 
ON a.id = b.LabGenericID 
JOIN cdr_V_MedicalRecordMain c 
ON a.PatientNo = c.PatientNo and a.Encounterid = c.EncounterID 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) d 
ON c.PatientNo = d.PatientNo 
where c.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) and (b.TestItemName = '谷丙转氨酶' or b.TestItemName = '天门冬氨酸氨基转移酶' or b.TestItemName = '总蛋白' or b.TestItemName = '白蛋白' or b.TestItemName = '球蛋白' or b.TestItemName = '总胆红素' or b.TestItemName = '直接胆红素' or b.TestItemName = 'γ谷氨酰基转移酶' or b.TestItemName = 'γ-谷氨酰转肽酶' or b.TestItemName = '碱性磷酸酶' or b.TestItemName = '乳酸脱氢酶' or b.TestItemName = '淀粉酶' or b.TestItemName = '肌酸激酶（CK-MB）' or b.TestItemName = '肌酸激酶' or b.TestItemName = '总胆汁酸' or b.TestItemName = '葡萄糖' or b.TestItemName = '糖化血红蛋白' or b.TestItemName = '糖化血红蛋白-A1c' or b.TestItemName = '肌酐' or b.TestItemName = 'eGFR' or b.TestItemName = '尿素氮' or b.TestItemName = '尿酸' or b.TestItemName = '钙' or b.TestItemName = '磷' or b.TestItemName = '镁' or b.TestItemName = '25-羟基维生素D' or b.TestItemName = '25-羟基维生素D(VITD)' or b.TestItemName = '钾' or b.TestItemName = '钠' or b.TestItemName = '氯' or b.TestItemName = '甘油三酯' or b.TestItemName = '甘油三脂' or b.TestItemName = '总胆固醇' or b.TestItemName = '高密度脂蛋白胆固醇' or b.TestItemName = '低密度脂蛋白胆固醇');

-- 心梗标志物和甲状腺相关
SELECT NVL(d.EMPI, d.PatientNo) AS EMPI, c.PatientNo as patient_no, CONCAT('***', SUBSTRING(c.IDNumber, 4, length(c.IDNumber)-7), '0000') as id_number, c.EncounterID as encounter_id, a.EncounterType as encounter_type, c.InpatientNumber as inpatient_number, c.OutpatientNumber as outpatient_number, CASE WHEN b.TestItemName = '肌钙蛋白I' or b.TestItemName = 'BNP' THEN 33 ELSE 34 END as question_id, b.LabGenericID as lab_generic_id, a.TSTest as ts_test, substr(a.TSTest, 0, 10) as ts_test_var, a.SpecimenClassName, b.TestItemName as table_item_name, b.TestItemCode as test_item_code, b.TestItemName as test_item_name, b.PrintValue as print_value, b.ResultValue as result_value, b.ResultUnit as result_unit, b.ReferenceText as reference_text, b.AbnormalFlag as abnormal_flag, b.AbnormalFlagName as abnormal_flag_name, '42502657200' as hospital_code, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date , a.tsdraw as ts_draw, substr(a.tsdraw, 0, 10) as ts_draw_var
FROM cdr_V_LabGenericReport a 
JOIN cdr_V_LabGenericResult b 
ON a.id = b.LabGenericID 
JOIN cdr_V_MedicalRecordMain c 
ON a.PatientNo = c.PatientNo and a.Encounterid = c.EncounterID 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) d 
ON c.PatientNo = d.PatientNo 
where c.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) and (b.TestItemName = '肌钙蛋白I' or b.TestItemName = 'BNP' or b.TestItemName = '总T3' or b.TestItemName = '总T4' or b.TestItemName = '游离T3' or b.TestItemName = '游离T4' or b.TestItemName = '促甲状腺激素(TSH)' or b.TestItemName = '甲状旁腺素');

-- 炎症标志物和免疫球蛋白
SELECT NVL(d.EMPI, d.PatientNo) AS EMPI, c.PatientNo as patient_no, CONCAT('***', SUBSTRING(c.IDNumber, 4, length(c.IDNumber)-7), '0000') as id_number, c.EncounterID as encounter_id, a.EncounterType as encounter_type, c.InpatientNumber as inpatient_number, c.OutpatientNumber as outpatient_number, CASE WHEN b.TestItemName = '红细胞沉降率ESR' or b.TestItemName = 'C反应蛋白' or b.TestItemName = 'C-反应蛋白' THEN 35 ELSE 36 END as question_id, b.LabGenericID as lab_generic_id, a.TSTest as ts_test, substr(a.TSTest, 0, 10) as ts_test_var, a.SpecimenClassName, CASE WHEN b.TestItemName = '免疫固定电泳IgG' then '免疫固定电泳 - IgG带' WHEN b.TestItemName = '免疫固定电泳IgA' then '免疫固定电泳 - IgA带' WHEN b.TestItemName = '免疫固定电泳IgM' then '免疫固定电泳 - IgM带' WHEN b.TestItemName = '免疫固定电泳kap' then '免疫固定电泳 - κ带' WHEN b.TestItemName = '免疫固定电泳lam' then '免疫固定电泳 - λ带' else b.TestItemName end as table_item_name, b.TestItemCode as test_item_code, b.TestItemName as test_item_name, b.PrintValue as print_value, b.ResultValue as result_value, b.ResultUnit as result_unit, b.ReferenceText as reference_text, b.AbnormalFlag as abnormal_flag, b.AbnormalFlagName as abnormal_flag_name, '42502657200' as hospital_code, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date , a.tsdraw as ts_draw, substr(a.tsdraw, 0, 10) as ts_draw_var
FROM cdr_V_LabGenericReport a 
JOIN cdr_V_LabGenericResult b 
ON a.id = b.LabGenericID 
JOIN cdr_V_MedicalRecordMain c 
ON a.PatientNo = c.PatientNo and a.Encounterid = c.EncounterID 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) d 
ON c.PatientNo = d.PatientNo 
where c.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) and (b.TestItemName = '红细胞沉降率ESR' or b.TestItemName = 'C反应蛋白' or b.TestItemName = 'C-反应蛋白' or b.TestItemName = '免疫球蛋白G' or b.TestItemName = '免疫球蛋白A' or b.TestItemName = '免疫球蛋白M' or b.TestItemName = '免疫球蛋白G4' or b.TestItemName = '免疫固定电泳IgG' or b.TestItemName = '免疫固定电泳IgA' or b.TestItemName = '免疫固定电泳IgM' or b.TestItemName = '免疫固定电泳kap' or b.TestItemName = '免疫固定电泳lam' or b.TestItemName = '免疫固定电泳');

-- 感染相关和补体相关
SELECT NVL(d.EMPI, d.PatientNo) AS EMPI, c.PatientNo as patient_no, CONCAT('***', SUBSTRING(c.IDNumber, 4, length(c.IDNumber)-7), '0000') as id_number, c.EncounterID as encounter_id, a.EncounterType as encounter_type, c.InpatientNumber as inpatient_number, c.OutpatientNumber as outpatient_number, CASE WHEN b.TestItemName = '总补体活性CH50' or b.TestItemName = '补体C3' or b.TestItemName = '补体C4' or b.TestItemName = 'C1抑制剂' or b.TestItemName = '补体C1Q' or b.TestItemName = '补体C1q' THEN 38 ELSE 37 END as question_id, b.LabGenericID as lab_generic_id, a.TSTest as ts_test, substr(a.TSTest, 0, 10) as ts_test_var, a.SpecimenClassName, CASE WHEN b.TestItemName = '乙肝e抗原' then '乙肝E抗原' WHEN b.TestItemName = '乙肝e抗体' then '乙肝E抗体' WHEN b.TestItemName = '抗EB病毒衣壳抗原IgG亲合力' then '抗EB病毒衣壳抗原IgG亲和力' WHEN b.TestItemName = '补体C1q' then '补体C1Q' else b.TestItemName end as table_item_name, b.TestItemCode as test_item_code, b.TestItemName as test_item_name, b.PrintValue as print_value, b.ResultValue as result_value, b.ResultUnit as result_unit, b.ReferenceText as reference_text, b.AbnormalFlag as abnormal_flag, b.AbnormalFlagName as abnormal_flag_name, '42502657200' as hospital_code, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date , a.tsdraw as ts_draw, substr(a.tsdraw, 0, 10) as ts_draw_var
FROM cdr_V_LabGenericReport a 
JOIN cdr_V_LabGenericResult b 
ON a.id = b.LabGenericID 
JOIN cdr_V_MedicalRecordMain c 
ON a.PatientNo = c.PatientNo and a.Encounterid = c.EncounterID 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) d 
ON c.PatientNo = d.PatientNo 
where c.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) and (b.TestItemName = '乙肝核心抗体IGM型' or b.TestItemName = '乙肝表面抗原' or b.TestItemName = '乙肝表面抗体' or b.TestItemName = '乙肝核心抗体' or b.TestItemName = '乙肝E抗原' or b.TestItemName = '乙肝e抗原' or b.TestItemName = '乙肝E抗体' or b.TestItemName = '乙肝e抗体' or b.TestItemName = 'HBV-DNA' or b.TestItemName = '梅毒甲苯胺红不加热血清试验(TRUST)' or b.TestItemName = '梅毒螺旋体抗体' or b.TestItemName = '巨细胞病毒-IgM抗体' or b.TestItemName = '巨细胞病毒-IgG抗体' or b.TestItemName = '巨细胞病毒DNA' or b.TestItemName = '抗EB病毒衣壳抗原IgG' or b.TestItemName = '抗EB病毒衣壳抗原IgM' or b.TestItemName = '抗EB病毒早期抗原IgG' or b.TestItemName = '抗EB病毒核抗原IgG' or b.TestItemName = '抗EB病毒衣壳抗原IgG亲合力' or b.TestItemName = 'EB病毒DNA' or b.TestItemName = 'T-SPOT' or b.TestItemName = '降钙素原' or b.TestItemName = '总补体活性CH50' or b.TestItemName = '补体C3' or b.TestItemName = '补体C4' or b.TestItemName = 'C1抑制剂' or b.TestItemName = '补体C1Q' or b.TestItemName = '补体C1q');

-- Coobm`s试验和其他自身抗体
SELECT NVL(d.EMPI, d.PatientNo) AS EMPI, c.PatientNo as patient_no, CONCAT('***', SUBSTRING(c.IDNumber, 4, length(c.IDNumber)-7), '0000') as id_number, c.EncounterID as encounter_id, a.EncounterType as encounter_type, c.InpatientNumber as inpatient_number, c.OutpatientNumber as outpatient_number, CASE WHEN b.TestItemName = '直抗' or b.TestItemName = '抗IgG' or b.TestItemName = '抗C3' or b.TestItemName = '抗体筛选' THEN 39 ELSE 40 END as question_id, b.LabGenericID as lab_generic_id, a.TSTest as ts_test, substr(a.TSTest, 0, 10) as ts_test_var, a.SpecimenClassName, CASE WHEN b.TestItemName = '直抗' then "Coomb's试验-直抗" WHEN b.TestItemName = '抗IgG' then "Coomb's试验-抗IgG" WHEN b.TestItemName = '抗C3' then "Coomb's试验-抗C3" WHEN b.TestItemName = '抗体筛选' then "Coomb's试验-抗体筛选" WHEN b.TestItemName = '抗GP Ⅸ抗体' then "抗血小板抗体 - 抗GP IX抗体" WHEN b.TestItemName = '抗GPⅠb抗体' then "抗血小板抗体 - 抗GP Ib抗体" WHEN b.TestItemName = '抗GP Ⅲa抗体' then "抗血小板抗体 - 抗GP IIIa抗体" WHEN b.TestItemName = '抗GP Ⅱb抗体' then "抗血小板抗体 - 抗GP IIb抗体" WHEN b.TestItemName = '抗GMP 140抗体' then "抗血小板抗体 - 抗GMP 140抗体" WHEN b.TestItemName = '线粒体抗体(AMA)' then "线粒体抗体（AMA）" WHEN b.TestItemName = '抗平滑肌抗体(ASMA)' then "抗平滑肌抗体（ASMA）" WHEN b.TestItemName = '抗可溶性肝抗原/肝胰抗原(SLA/LP)' then "抗可溶性肝抗体/肝胰抗原（SLA/LP）" WHEN b.TestItemName = '抗肝溶质抗1型抗原(LC-1)抗体' then "抗肝溶质抗1型抗原（LC-1）抗体" WHEN b.TestItemName = '抗肝肾微粒体(LKM-1)抗体' then "抗肝肾微粒体（LKM-1）抗体" WHEN b.TestItemName = '抗糖蛋白210(gp210)抗体' then "抗糖蛋白201（gp210）抗体" WHEN b.TestItemName = '抗早幼粒细胞白血病蛋白(PML)抗体' then "抗早幼粒细胞白血病蛋白（PML）抗体" WHEN b.TestItemName = '抗斑点蛋白(Sp100)抗体' then "抗斑点蛋白（Sp100）抗体" WHEN b.TestItemName = '抗2-丙酮酸脱氢酶(M2-3E)抗体' then "抗2-丙酮酸脱氢酶（M2-3E）抗体" else b.TestItemName end as table_item_name, b.TestItemCode as test_item_code, b.TestItemName as test_item_name, b.PrintValue as print_value, b.ResultValue as result_value, b.ResultUnit as result_unit, b.ReferenceText as reference_text, b.AbnormalFlag as abnormal_flag, b.AbnormalFlagName as abnormal_flag_name, '42502657200' as hospital_code, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date , a.tsdraw as ts_draw, substr(a.tsdraw, 0, 10) as ts_draw_var
FROM cdr_V_LabGenericReport a 
JOIN cdr_V_LabGenericResult b 
ON a.id = b.LabGenericID 
JOIN cdr_V_MedicalRecordMain c 
ON a.PatientNo = c.PatientNo and a.Encounterid = c.EncounterID 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) d 
ON c.PatientNo = d.PatientNo 
where c.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) and (b.TestItemName = '直抗' or b.TestItemName = '抗IgG' or b.TestItemName = '抗C3' or b.TestItemName = '抗体筛选' or b.TestItemName = '类风湿因子IgG型' or b.TestItemName = '类风湿因子IgA型' or b.TestItemName = '类风湿因子IgM型' or b.TestItemName = '抗环瓜氨酸肽(CCP)抗体' or b.TestItemName = '抗髓过氧化物酶抗体(Anti-MPO)' or b.TestItemName = '抗蛋白酶3抗体(Anti-PR3)' or b.TestItemName = '核周型ANCA(P-ANCA)' or b.TestItemName = '胞浆型ANCA(C-ANCA)' or b.TestItemName = '甲状腺球蛋白抗体' or b.TestItemName = '抗甲状腺过氧化物酶抗体' or b.TestItemName = '促甲状腺素受体抗体' or b.TestItemName = '抗肾小球基底膜IgG抗体' or b.TestItemName = '抗磷脂酶A2受体抗体IgG' or b.TestItemName = '抗GP Ⅸ抗体' or b.TestItemName = '抗GPⅠb抗体' or b.TestItemName = '抗GP Ⅲa抗体' or b.TestItemName = '抗GP Ⅱb抗体' or b.TestItemName = '抗GMP 140抗体' or b.TestItemName = 'ANA(核型1)' or b.TestItemName = 'ANA(核型2)' or b.TestItemName = 'ANA(核型3)' or b.TestItemName = '线粒体抗体(AMA)' or b.TestItemName = '抗平滑肌抗体(ASMA)' or b.TestItemName = '抗Ro52抗体' or b.TestItemName = '抗可溶性肝抗原/肝胰抗原(SLA/LP)' or b.TestItemName = '抗肝溶质抗1型抗原(LC-1)抗体' or b.TestItemName = '抗肝肾微粒体(LKM-1)抗体' or b.TestItemName = '抗糖蛋白210(gp210)抗体' or b.TestItemName = '抗早幼粒细胞白血病蛋白(PML)抗体' or b.TestItemName = '抗斑点蛋白(Sp100)抗体' or b.TestItemName = '抗线粒体-M2型抗体' or b.TestItemName = '抗2-丙酮酸脱氢酶(M2-3E)抗体' or b.TestItemName = '抗F肌动蛋白（F-Actin）抗体');

-- ANA+ENA+dsDNA组合
SELECT NVL(d.EMPI, d.PatientNo) AS EMPI, c.PatientNo as patient_no, CONCAT('***', SUBSTRING(c.IDNumber, 4, length(c.IDNumber)-7), '0000') as id_number, c.EncounterID as encounter_id, a.EncounterType as encounter_type, c.InpatientNumber as inpatient_number, c.OutpatientNumber as outpatient_number, 41 as question_id, b.LabGenericID as lab_generic_id, a.TSTest as ts_test, substr(a.TSTest, 0, 10) as ts_test_var, a.SpecimenClassName, CASE WHEN b.TestItemName = '抗SM' then '抗Sm' WHEN b.TestItemName = '抗SSB/La抗体' then '抗SSB/La' WHEN b.TestItemName = '抗Jo-1抗体' then '抗Jo-1' WHEN b.TestItemName = '抗核小体抗体' then '核小体抗体' WHEN b.TestItemName = '抗ds-DNA(ELISA法)' then '抗ds-DNA(ELISA法）' WHEN b.TestItemName = '抗ds-DNA(短膜虫法)' then '抗ds-DNA（短膜虫法）' else b.TestItemName end as table_item_name, b.TestItemCode as test_item_code, b.TestItemName as test_item_name, b.PrintValue as print_value, b.ResultValue as result_value, b.ResultUnit as result_unit, b.ReferenceText as reference_text, b.AbnormalFlag as abnormal_flag, b.AbnormalFlagName as abnormal_flag_name, '42502657200' as hospital_code, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date , a.tsdraw as ts_draw, substr(a.tsdraw, 0, 10) as ts_draw_var
FROM cdr_V_LabGenericReport a 
JOIN cdr_V_LabGenericResult b 
ON a.id = b.LabGenericID 
JOIN cdr_V_MedicalRecordMain c 
ON a.PatientNo = c.PatientNo and a.Encounterid = c.EncounterID 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) d 
ON c.PatientNo = d.PatientNo 
where c.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) and (b.TestItemName = 'ANA滴度' or b.TestItemName = 'ANA核型' or b.TestItemName = '抗Sm' or b.TestItemName = '抗SM' or b.TestItemName = '抗nRNP/Sm' or b.TestItemName = '抗Ro52抗体' or b.TestItemName = '抗SSA-Ro60' or b.TestItemName = '抗SSB/La' or b.TestItemName = '抗SSB/La抗体' or b.TestItemName = '抗Jo-1' or b.TestItemName = '抗Jo-1抗体' or b.TestItemName = '抗Scl-70' or b.TestItemName = '抗核糖体P-蛋白抗体' or b.TestItemName = '抗组蛋白抗体' or b.TestItemName = '抗着丝点蛋白B抗体' or b.TestItemName = '抗PM-Scl抗体' or b.TestItemName = '抗增殖细胞核抗原抗体' or b.TestItemName = '抗线粒体-M2型抗体' or b.TestItemName = '核小体抗体' or b.TestItemName = '抗核小体抗体' or b.TestItemName = '抗ds-DNA(ELISA法)' or b.TestItemName = '抗ds-DNA(短膜虫法)' or b.TestItemName = '抗ds-DNA（Farr）');

-- 抗磷脂抗体相关
SELECT NVL(d.EMPI, d.PatientNo) AS EMPI, c.PatientNo as patient_no, CONCAT('***', SUBSTRING(c.IDNumber, 4, length(c.IDNumber)-7), '0000') as id_number, c.EncounterID as encounter_id, a.EncounterType as encounter_type, c.InpatientNumber as inpatient_number, c.OutpatientNumber as outpatient_number, 42 as question_id, b.LabGenericID as lab_generic_id, a.TSTest as ts_test, substr(a.TSTest, 0, 10) as ts_test_var, a.SpecimenClassName, CASE WHEN b.TestItemName = '标准化狼疮比值' then '狼疮抗凝物-标准化狼疮比值（TR）' else b.TestItemName end as table_item_name, b.TestItemCode as test_item_code, b.TestItemName as test_item_name, b.PrintValue as print_value, b.ResultValue as result_value, b.ResultUnit as result_unit, b.ReferenceText as reference_text, b.AbnormalFlag as abnormal_flag, b.AbnormalFlagName as abnormal_flag_name, '42502657200' as hospital_code, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date , a.tsdraw as ts_draw, substr(a.tsdraw, 0, 10) as ts_draw_var
FROM cdr_V_LabGenericReport a 
JOIN cdr_V_LabGenericResult b 
ON a.id = b.LabGenericID 
JOIN cdr_V_MedicalRecordMain c 
ON a.PatientNo = c.PatientNo and a.Encounterid = c.EncounterID 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) d 
ON c.PatientNo = d.PatientNo 
where c.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) and (b.TestItemName = '抗心磷脂抗体IgA' or b.TestItemName = '抗心磷脂抗体IgM' or b.TestItemName = '抗心磷脂抗体IgG' or b.TestItemName = '抗Beta2GP1抗体IgG' or b.TestItemName = '抗Beta2GP1抗体IgM' or b.TestItemName = '狼疮抗凝物-标准化狼疮比值（TR）' or b.TestItemName = '标准化狼疮比值');

-- 免疫细胞分型
SELECT NVL(d.EMPI, d.PatientNo) AS EMPI, c.PatientNo as patient_no, CONCAT('***', SUBSTRING(c.IDNumber, 4, length(c.IDNumber)-7), '0000') as id_number, c.EncounterID as encounter_id, a.EncounterType as encounter_type, c.InpatientNumber as inpatient_number, c.OutpatientNumber as outpatient_number, 43 as question_id, b.LabGenericID as lab_generic_id, a.TSTest as ts_test, substr(a.TSTest, 0, 10) as ts_test_var, a.SpecimenClassName, CASE WHEN b.TestItemName = '淋巴细胞绝对值（CD45+）' then '淋巴细胞(CD45+)绝对值' WHEN b.TestItemName = 'T淋巴细胞绝对值' then 'T淋巴细胞(CD3+)绝对值' WHEN b.TestItemName = 'T淋巴细胞（CD3+）' or b.TestItemName = 'T淋巴细胞CD3' then 'T淋巴细胞(CD3+)' WHEN b.TestItemName = 'Ts淋巴细胞绝对值' then 'Ts淋巴细胞(CD3+CD8+)绝对值' WHEN b.TestItemName = 'Th淋巴细胞绝对值' then 'Th淋巴细胞(CD3+CD4+)绝对值' WHEN b.TestItemName = 'Th淋巴细胞（CD3+CD4+）' then 'Th淋巴细胞(CD3+CD4+)' WHEN b.TestItemName = 'B淋巴细胞绝对值' then 'B淋巴细胞(CD3-CD19+)绝对值' WHEN b.TestItemName = 'B淋巴细胞（CD3-CD19+）' then 'B淋巴细胞(CD3-CD19+)' WHEN b.TestItemName = '自然杀伤细胞绝对值' then '自然杀伤细胞(CD3-CD16+CD56+)绝对值' WHEN b.TestItemName = 'CD3-CD20+' then 'CD20细胞比值(CD3-CD20+)' WHEN b.TestItemName = 'CD45/3/14/38/19/27(浆细胞/B细胞比率)' then '浆细胞(CD45/3/14/38/19/27)' else b.TestItemName end as table_item_name, b.TestItemCode as test_item_code, b.TestItemName as test_item_name, b.PrintValue as print_value, b.ResultValue as result_value, b.ResultUnit as result_unit, b.ReferenceText as reference_text, b.AbnormalFlag as abnormal_flag, b.AbnormalFlagName as abnormal_flag_name, '42502657200' as hospital_code, FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd HH:mm:ss') as create_date , a.tsdraw as ts_draw, substr(a.tsdraw, 0, 10) as ts_draw_var
FROM cdr_V_LabGenericReport a 
JOIN cdr_V_LabGenericResult b 
ON a.id = b.LabGenericID 
JOIN cdr_V_MedicalRecordMain c 
ON a.PatientNo = c.PatientNo and a.Encounterid = c.EncounterID 
JOIN (select distinct empi, patientno from dw.empi_cdw where effect_flag = 1 and patientno in (SELECT DISTINCT patientno FROM skzbk.fs_medicalrecordmain_ls_temp)) d 
ON c.PatientNo = d.PatientNo 
where c.id in (SELECT medicalrecordid FROM cdr_v_MedicalRecordDiagnose WHERE TRIM(DiagnoseCode) IN ('A18.400x001', 'A18.409', 'A18.410', 'D68.600x011', 'D86.300x002', 'F06.800x021', 'H01.100x006', 'K71.500x002', 'K73.200x011', 'K75.400x001', 'L73.801', 'L93.000x002', 'L93.001', 'L93.100', 'L93.200', 'L93.200x001', 'L93.200x003', 'L93.201', 'L93.202', 'M32.000', 'M32.100', 'M32.100x001', 'M32.100x006', 'M32.100x007', 'M32.100x008', 'M32.100x014', 'M32.100x016', 'M32.100x018', 'M32.100x021', 'M32.101†', 'M32.102†', 'M32.103†', 'M32.104†', 'M32.105†', 'M32.106†', 'M32.107†', 'M32.108†', 'M32.109†', 'M32.110†', 'M32.111†', 'M32.112†', 'M32.113†', 'M32.114†', 'M32.115†', 'M32.800', 'M32.900', 'M32.901', 'O99.811', 'M32.101+', 'M32.102+', 'M32.103+', 'M32.104+', 'M32.105+', 'M32.106+', 'M32.107+', 'M32.108+', 'M32.109+', 'M32.110+', 'M32.111+', 'M32.112+', 'M32.113+', 'M32.114+', 'M32.115+')) and (b.TestItemName = '淋巴细胞绝对值（CD45+）' or b.TestItemName = 'T淋巴细胞绝对值' or b.TestItemName = 'T淋巴细胞（CD3+）' or b.TestItemName = 'T淋巴细胞CD3' or b.TestItemName = 'Ts淋巴细胞(CD3+CD8+)绝对值' or b.TestItemName = 'Ts淋巴细胞(CD3+CD8+)' or b.TestItemName = 'Th淋巴细胞绝对值' or b.TestItemName = 'Th淋巴细胞（CD3+CD4+）' or b.TestItemName = 'B淋巴细胞绝对值' or b.TestItemName = 'B淋巴细胞（CD3-CD19+）' or b.TestItemName = '自然杀伤细胞绝对值' or b.TestItemName = '自然杀伤细胞(CD3-CD16+CD56+)' or b.TestItemName = 'CD4/CD8比值' or b.TestItemName = 'CD3-CD20+' or b.TestItemName = 'CD45/3/14/38/19/27(浆细胞/B细胞比率)');


-- 门诊用药
SELECT * FROM cdr_v_OUTPATIENTVISITRECORD a 
JOIN (SELECT DISTINCT patientno, inpatientnumber, outhospitaltime FROM cdr_v_MEDICALRECORDMAIN WHERE inpatientnumber in ('2000308343','2000308238','2000308761','2000308823','2000309343','2000310000','2000310110','2000310128','2000310406','2000310811','2000311144','2000312439','2000312335','2000312416','2000312331','2000311563','2000312224','2000312900','2000312868','2000313371','2000313352','2000313245','2000313052','2000314019','2000312577','2000314090','2000312829','2000313486','2000312967','2000313654','2000314297','2000314517','2000315436','2000315317','2000317500','2000317030','2000317408','2000317367','2000317491','2000317496','2000318024','2000317887','2000317602','2000318721','2000318782','2000316668','2000318803','2000319866','2000319873','2000319064','2000319812','2000319944','2000321083','2000320860','2000320957','2000321997','2000320751','2000321562','2000321583','2000322430','2000322186','2000322445','2000322727','2000322905','2000323324','2000323283','2000323375','2000323700','2000323788','2000324038','2000323883','2000324741','2000324627','2000325214','2000324782','2000324912','2000325084','2000325650','2000325706','2000325697','2000326074','2000326265','2000326580','2000326777','2000326208','2000326184','2000327798','2000327954','2000327608','2000328506','2000328162','2000328459','2000328245','2000329499','2000329561','2000329599','2000329629','2000329739','2000329939','2000329723','2000329914','2000329845','2000331197','2000331226','2000330999','2000331570','2000331333','2000331703','2000332476','2000332466','2000332963','2000333257','2000354289','2000357663','2000358347','2000358314','2000358020','2000359494','2000359305','2000359691','2000359743','2000334090','2000334690','2000360918','2000361099','2000361196','2000361471','2000334934','2000362032','2000362139','2000362390','200010975','2000362747','2000364442','2000364090','2000335951','2000336193','2000335956','2000336244','2000336054','2000337781','2000339564','2000339596','2000339622','2000339947','2000340132','2000339883','2000339781','2000340000','2000341474','2000341557','2000341347','2000342524','2000342256','2000342346','2000340711','2000340689','2000340249','2000340574','2000340587','2000340722','2000343322','2000343324','2000342747','2000344146','2000343971','2000343843','2000343704','2000343601','2000344602','2000345462','2000345117','2000346310','2000345984','2000345674','2000347505','2000346714','2000345661','2000348911','2000350278','2000351531','2000351676','2000352351','2000352254','2000352913','2000353454','2000354233','2000354893','2000355476','2000355383','2000355660','2000355912','2000355251','2000356048','2000355568','2000365890','2000366108','2000366167','2000366053','2000366972','2000366261','2000368426','2000368822','2000368806','2000368108','2000370125','2000369525','2000369814','2000369843','2000370020','2000371187','2000368960','2000370754','2000368374','2000374346','2000373743','2000374435','2000374617','2000376093','2000378707','2000378119','2000377991','2000378508','2000279196','2000379547','2000380194','2000380447','20001902457','2000380774','2000380490','2000379260','2000383002','2000383103','2000383953','2000382127','2000386096','2000386767','2000386728','2000385496','2000385154','2000385506','2000385515','2000383967','2000388855','2000387523','2000389879','2000389390','2000390335','2000390525','2000390960','2000391253','2000391632','2000392164','2000392078','2000388305','2000390865','2000392348','2000391858','2000393450','2000391853','2000393491','2000394164','2000393887','2000394072','2000394698','2000394957','2000395240','2000395192','2000395609','2000395700','2000398059','2000398037','2000398070','2000397472','2000397947','2000398675','2000398840','2000397768','2000397913','2000394900','2000398989','2000396398','2000396272','2000395779','2000396443','2000400197','2000399597','2000400388','2000396677','2000397220','2000397260','2000401786','2000401962','2000401771','2000401752','2000402416','2000401453','2000401970','2000402518','2000402569','2000404060','2000404313','2000405057','2000405594','2000405799','2000406324','2000406663','2000406057','2000406848','2000406870','2000407438','2000407217','2000406491','2000408388','2000407299','2000408516','2000408816','2000409487','2000410763','2000410875','2000411500','2000411128','2000410873','2000412227','2000412112','2000410900','2000413013','2000412354','2000412775','2000413104','2000412828','2000413490','2000414043','2000413290','2000414267','2000414741','2000415244','2000415285','2000416012','2000415740','2000416970','2000416811','2000417522','2000416965','2000416355','2000416649','2000417618','2000417749','2000418415','2000417616','2000418375','2000419012','2000419023','2000418897','2000418836','2000419163','2000419801','2000419527','2000419954','2000420144','2000419328','2000421057','2000421616','2000419931','2000422498','2000422602','2000423358','2000423644','2000423858','2000424610','2000424396','2000426331','2000425447','2000426206','2000426336','2000426520','2000427001','2000427190','2000426893','2000427700','2000427776','2000429682','2000429560','2000430489','2000430151','2000430944','2000430484','2000430453','2000432563','2000432459','2000433388','2000433386','2000434270','2000434212','2000435064','2000434889','2000433922','2000434060','2000434883','2000435454','2000435460','2000436260','2000436928','2000436650','2000436458','2000438051','2000438050','2000438044','2000438365','2000438197','2000439692','2000438604','2000438786','2000440024','2000439977','2000439871','2000441049','2000440861','2000441181','2000440916','2000441722','2000442634','2000441025','2000442621','2000443823','2000443677','2000443841','2000444813','2000444479','2000444010','2000443879','2000444547','2000445787','2000445891','2000445942','2000445930','2000446648','2000445800','2000446690','2000446447','2000447538','2000446963','2000447685','2000450234','2000450245','2000451030','2000450872','2000450821','2000450092','2000450461','2000451300','2000451949','2000452286','2000453074','2000453312','2000453361','2000452422','2000453883','2000453965','2000454637','2000454628','2000454779','2000455716','2000456151','2000457556','2000458044','2000457897','2000457698','2000458687','2000459219','2000458503','2000459237','2000458684','2000459779','2000459681','2000459740','2000458873','2000460902','2000461559','2000461720','2000461696','2000462430','2000462051')) b on a.patientno = b.patientno 
JOIN cdr_v_OUTPATIENTRECIPE c 
on a.patientno = c.patientno and a.id = c.outpatientvisitid 
JOIN cdr_v_OUTPATIENTRECIPEDETAIL d 
on c.id = d.outpatientrecipeid;

-- 门诊检验
SELECT * FROM cdr_v_OUTPATIENTVISITRECORD a 
JOIN (SELECT DISTINCT patientno, inpatientnumber, outhospitaltime FROM cdr_v_MEDICALRECORDMAIN WHERE inpatientnumber in ('2000308343','2000308238','2000308761','2000308823','2000309343','2000310000','2000310110','2000310128','2000310406','2000310811','2000311144','2000312439','2000312335','2000312416','2000312331','2000311563','2000312224','2000312900','2000312868','2000313371','2000313352','2000313245','2000313052','2000314019','2000312577','2000314090','2000312829','2000313486','2000312967','2000313654','2000314297','2000314517','2000315436','2000315317','2000317500','2000317030','2000317408','2000317367','2000317491','2000317496','2000318024','2000317887','2000317602','2000318721','2000318782','2000316668','2000318803','2000319866','2000319873','2000319064','2000319812','2000319944','2000321083','2000320860','2000320957','2000321997','2000320751','2000321562','2000321583','2000322430','2000322186','2000322445','2000322727','2000322905','2000323324','2000323283','2000323375','2000323700','2000323788','2000324038','2000323883','2000324741','2000324627','2000325214','2000324782','2000324912','2000325084','2000325650','2000325706','2000325697','2000326074','2000326265','2000326580','2000326777','2000326208','2000326184','2000327798','2000327954','2000327608','2000328506','2000328162','2000328459','2000328245','2000329499','2000329561','2000329599','2000329629','2000329739','2000329939','2000329723','2000329914','2000329845','2000331197','2000331226','2000330999','2000331570','2000331333','2000331703','2000332476','2000332466','2000332963','2000333257','2000354289','2000357663','2000358347','2000358314','2000358020','2000359494','2000359305','2000359691','2000359743','2000334090','2000334690','2000360918','2000361099','2000361196','2000361471','2000334934','2000362032','2000362139','2000362390','200010975','2000362747','2000364442','2000364090','2000335951','2000336193','2000335956','2000336244','2000336054','2000337781','2000339564','2000339596','2000339622','2000339947','2000340132','2000339883','2000339781','2000340000','2000341474','2000341557','2000341347','2000342524','2000342256','2000342346','2000340711','2000340689','2000340249','2000340574','2000340587','2000340722','2000343322','2000343324','2000342747','2000344146','2000343971','2000343843','2000343704','2000343601','2000344602','2000345462','2000345117','2000346310','2000345984','2000345674','2000347505','2000346714','2000345661','2000348911','2000350278','2000351531','2000351676','2000352351','2000352254','2000352913','2000353454','2000354233','2000354893','2000355476','2000355383','2000355660','2000355912','2000355251','2000356048','2000355568','2000365890','2000366108','2000366167','2000366053','2000366972','2000366261','2000368426','2000368822','2000368806','2000368108','2000370125','2000369525','2000369814','2000369843','2000370020','2000371187','2000368960','2000370754','2000368374','2000374346','2000373743','2000374435','2000374617','2000376093','2000378707','2000378119','2000377991','2000378508','2000279196','2000379547','2000380194','2000380447','20001902457','2000380774','2000380490','2000379260','2000383002','2000383103','2000383953','2000382127','2000386096','2000386767','2000386728','2000385496','2000385154','2000385506','2000385515','2000383967','2000388855','2000387523','2000389879','2000389390','2000390335','2000390525','2000390960','2000391253','2000391632','2000392164','2000392078','2000388305','2000390865','2000392348','2000391858','2000393450','2000391853','2000393491','2000394164','2000393887','2000394072','2000394698','2000394957','2000395240','2000395192','2000395609','2000395700','2000398059','2000398037','2000398070','2000397472','2000397947','2000398675','2000398840','2000397768','2000397913','2000394900','2000398989','2000396398','2000396272','2000395779','2000396443','2000400197','2000399597','2000400388','2000396677','2000397220','2000397260','2000401786','2000401962','2000401771','2000401752','2000402416','2000401453','2000401970','2000402518','2000402569','2000404060','2000404313','2000405057','2000405594','2000405799','2000406324','2000406663','2000406057','2000406848','2000406870','2000407438','2000407217','2000406491','2000408388','2000407299','2000408516','2000408816','2000409487','2000410763','2000410875','2000411500','2000411128','2000410873','2000412227','2000412112','2000410900','2000413013','2000412354','2000412775','2000413104','2000412828','2000413490','2000414043','2000413290','2000414267','2000414741','2000415244','2000415285','2000416012','2000415740','2000416970','2000416811','2000417522','2000416965','2000416355','2000416649','2000417618','2000417749','2000418415','2000417616','2000418375','2000419012','2000419023','2000418897','2000418836','2000419163','2000419801','2000419527','2000419954','2000420144','2000419328','2000421057','2000421616','2000419931','2000422498','2000422602','2000423358','2000423644','2000423858','2000424610','2000424396','2000426331','2000425447','2000426206','2000426336','2000426520','2000427001','2000427190','2000426893','2000427700','2000427776','2000429682','2000429560','2000430489','2000430151','2000430944','2000430484','2000430453','2000432563','2000432459','2000433388','2000433386','2000434270','2000434212','2000435064','2000434889','2000433922','2000434060','2000434883','2000435454','2000435460','2000436260','2000436928','2000436650','2000436458','2000438051','2000438050','2000438044','2000438365','2000438197','2000439692','2000438604','2000438786','2000440024','2000439977','2000439871','2000441049','2000440861','2000441181','2000440916','2000441722','2000442634','2000441025','2000442621','2000443823','2000443677','2000443841','2000444813','2000444479','2000444010','2000443879','2000444547','2000445787','2000445891','2000445942','2000445930','2000446648','2000445800','2000446690','2000446447','2000447538','2000446963','2000447685','2000450234','2000450245','2000451030','2000450872','2000450821','2000450092','2000450461','2000451300','2000451949','2000452286','2000453074','2000453312','2000453361','2000452422','2000453883','2000453965','2000454637','2000454628','2000454779','2000455716','2000456151','2000457556','2000458044','2000457897','2000457698','2000458687','2000459219','2000458503','2000459237','2000458684','2000459779','2000459681','2000459740','2000458873','2000460902','2000461559','2000461720','2000461696','2000462430','2000462051')) b 
ON a.patientno = b.patientno 
JOIN cdr_v_LABGENERICREPORT c 
on a.patientno = c.patientno and a.id = c.encounterid 
JOIN cdr_v_LABGENERICRESULT d 
on c.id = d.labgenericid;

-- 住院号
SELECT DISTINCT a.patientname, a.age, a.sex, a.patientno, a.inpatientnumber, a.inhospitaltime, a.outhospitaltime, b.inhospitaltime FROM cdr_v_MEDICALRECORDMAIN a JOIN (SELECT DISTINCT patientno, inpatientnumber, inhospitaltime, outhospitaltime FROM cdr_v_MEDICALRECORDMAIN WHERE inpatientnumber in ('2000308343','2000308238','2000308761','2000308823','2000309343','2000310000','2000310110','2000310128','2000310406','2000310811','2000311144','2000312439','2000312335','2000312416','2000312331','2000311563','2000312224','2000312900','2000312868','2000313371','2000313352','2000313245','2000313052','2000314019','2000312577','2000314090','2000312829','2000313486','2000312967','2000313654','2000314297','2000314517','2000315436','2000315317','2000317500','2000317030','2000317408','2000317367','2000317491','2000317496','2000318024','2000317887','2000317602','2000318721','2000318782','2000316668','2000318803','2000319866','2000319873','2000319064','2000319812','2000319944','2000321083','2000320860','2000320957','2000321997','2000320751','2000321562','2000321583','2000322430','2000322186','2000322445','2000322727','2000322905','2000323324','2000323283','2000323375','2000323700','2000323788','2000324038','2000323883','2000324741','2000324627','2000325214','2000324782','2000324912','2000325084','2000325650','2000325706','2000325697','2000326074','2000326265','2000326580','2000326777','2000326208','2000326184','2000327798','2000327954','2000327608','2000328506','2000328162','2000328459','2000328245','2000329499','2000329561','2000329599','2000329629','2000329739','2000329939','2000329723','2000329914','2000329845','2000331197','2000331226','2000330999','2000331570','2000331333','2000331703','2000332476','2000332466','2000332963','2000333257','2000354289','2000357663','2000358347','2000358314','2000358020','2000359494','2000359305','2000359691','2000359743','2000334090','2000334690','2000360918','2000361099','2000361196','2000361471','2000334934','2000362032','2000362139','2000362390','200010975','2000362747','2000364442','2000364090','2000335951','2000336193','2000335956','2000336244','2000336054','2000337781','2000339564','2000339596','2000339622','2000339947','2000340132','2000339883','2000339781','2000340000','2000341474','2000341557','2000341347','2000342524','2000342256','2000342346','2000340711','2000340689','2000340249','2000340574','2000340587','2000340722','2000343322','2000343324','2000342747','2000344146','2000343971','2000343843','2000343704','2000343601','2000344602','2000345462','2000345117','2000346310','2000345984','2000345674','2000347505','2000346714','2000345661','2000348911','2000350278','2000351531','2000351676','2000352351','2000352254','2000352913','2000353454','2000354233','2000354893','2000355476','2000355383','2000355660','2000355912','2000355251','2000356048','2000355568','2000365890','2000366108','2000366167','2000366053','2000366972','2000366261','2000368426','2000368822','2000368806','2000368108','2000370125','2000369525','2000369814','2000369843','2000370020','2000371187','2000368960','2000370754','2000368374','2000374346','2000373743','2000374435','2000374617','2000376093','2000378707','2000378119','2000377991','2000378508','2000279196','2000379547','2000380194','2000380447','20001902457','2000380774','2000380490','2000379260','2000383002','2000383103','2000383953','2000382127','2000386096','2000386767','2000386728','2000385496','2000385154','2000385506','2000385515','2000383967','2000388855','2000387523','2000389879','2000389390','2000390335','2000390525','2000390960','2000391253','2000391632','2000392164','2000392078','2000388305','2000390865','2000392348','2000391858','2000393450','2000391853','2000393491','2000394164','2000393887','2000394072','2000394698','2000394957','2000395240','2000395192','2000395609','2000395700','2000398059','2000398037','2000398070','2000397472','2000397947','2000398675','2000398840','2000397768','2000397913','2000394900','2000398989','2000396398','2000396272','2000395779','2000396443','2000400197','2000399597','2000400388','2000396677','2000397220','2000397260','2000401786','2000401962','2000401771','2000401752','2000402416','2000401453','2000401970','2000402518','2000402569','2000404060','2000404313','2000405057','2000405594','2000405799','2000406324','2000406663','2000406057','2000406848','2000406870','2000407438','2000407217','2000406491','2000408388','2000407299','2000408516','2000408816','2000409487','2000410763','2000410875','2000411500','2000411128','2000410873','2000412227','2000412112','2000410900','2000413013','2000412354','2000412775','2000413104','2000412828','2000413490','2000414043','2000413290','2000414267','2000414741','2000415244','2000415285','2000416012','2000415740','2000416970','2000416811','2000417522','2000416965','2000416355','2000416649','2000417618','2000417749','2000418415','2000417616','2000418375','2000419012','2000419023','2000418897','2000418836','2000419163','2000419801','2000419527','2000419954','2000420144','2000419328','2000421057','2000421616','2000419931','2000422498','2000422602','2000423358','2000423644','2000423858','2000424610','2000424396','2000426331','2000425447','2000426206','2000426336','2000426520','2000427001','2000427190','2000426893','2000427700','2000427776','2000429682','2000429560','2000430489','2000430151','2000430944','2000430484','2000430453','2000432563','2000432459','2000433388','2000433386','2000434270','2000434212','2000435064','2000434889','2000433922','2000434060','2000434883','2000435454','2000435460','2000436260','2000436928','2000436650','2000436458','2000438051','2000438050','2000438044','2000438365','2000438197','2000439692','2000438604','2000438786','2000440024','2000439977','2000439871','2000441049','2000440861','2000441181','2000440916','2000441722','2000442634','2000441025','2000442621','2000443823','2000443677','2000443841','2000444813','2000444479','2000444010','2000443879','2000444547','2000445787','2000445891','2000445942','2000445930','2000446648','2000445800','2000446690','2000446447','2000447538','2000446963','2000447685','2000450234','2000450245','2000451030','2000450872','2000450821','2000450092','2000450461','2000451300','2000451949','2000452286','2000453074','2000453312','2000453361','2000452422','2000453883','2000453965','2000454637','2000454628','2000454779','2000455716','2000456151','2000457556','2000458044','2000457897','2000457698','2000458687','2000459219','2000458503','2000459237','2000458684','2000459779','2000459681','2000459740','2000458873','2000460902','2000461559','2000461720','2000461696','2000462430','2000462051')) b 
on a.patientno = b.patientno 
WHERE a.inhospitaltime > b.inhospitaltime;

-- 身高体重
SELECT * FROM 
(SELECT DISTINCT patientno, inpatientnumber, encounterid FROM cdr_v_MEDICALRECORDMAIN WHERE inpatientnumber in ('2000213338','2000213389','2000213441','2000213660','2000213585','2000213924','2000214242','2000214347','2000214982','2000215099','2000215153','2000215602','2000216153','2000216171','2000216243','2000216930','2000217344','2000217244','2000217481','2000217817','2000217897','2000218278','2000218268','2000218471','2000218790','2000218917','2000218910','2000219051','2000219710','2000219778','2000220618','2000220756','2000220772','2000220808','2000221259','2000221269','2000221424','2000221588','2000221872','2000222417','2000223986','2000225105','2000225251','2000242220','2000224623','2000225209','2000213491','2000213492','2000213624','2000213787','2000215434','2000216903','2000217213','2000217542','2000217948','2000217953','2000219373','2000220204','2000220755','2000221558','2000221824','2000222727','2000223040','2000225518','2000228130','2000242648','2000220164','2000213176','2000213630','2000213798','2000214166','2000214328','2000215125','2000215527','2000215598','2000215833','2000216141','2000217137','2000217484','2000217430','2000217445','2000217821','2000218141','2000218147','2000218120','2000218496','2000219050','2000219395','2000219417','2000219551','2000219570','2000219560','2000219569','2000219704','2000220163','2000220160','2000220138','2000220514','2000220835','2000220832','2000221199','2000221795','2000222534','2000222883','2000222998','2000223090','2000224262','2000224249','2000224515','2000225323','2000225597','2000226639','2000236480','2000236683','2000236681','2000236964','2000222139','2000220149','2000305338','2000305000','2000305930','2000307665','2000307591','2000307755','2000308238','2000308343','2000308463','2000308821','2000308868','2000308913','2000309364','2000309452','2000310184','2000310813','2000310427','2000310292','2000311041','2000311277','2000311321','2000311428','2000312111','2000312577','2000312738','2000312967','2000313501','2000314019','2000314292','2000314617','2000316420','2000316512','2000316540','2000316733','2000317002','2000317030','2000305600','2000309670','2000311669','2000312906','2000314026','2000315492','2000317204','2000317409','2000317499','2000318015','2000318318','2000318439','2000318502','2000318620','2000318576','2000318833','2000319137','2000319333','2000320255','2000320459','2000320817','2000320546','2000321566','2000320734','2000322185','2000322590','2000322626','2000322923','2000323311','2000323276','2000323375','2000323515','2000323817','2000324063','2000324184','2000324548','2000324716','2000324898','2000325204','2000325305','2000325394','2000325475','2000325602','2000326399','2000326557','2000326545','2000326667','2000326684','2000326999','2000327280','2000327307','2000327430','2000327829','2000328266','2000327795','2000328430','2000328507','2000328511','2000328841','2000328409','2000329066','2000329131','2000329946','2000330177','2000330212','2000330290','2000330498','2000330687','2000330715','2000331003','2000331291','2000331561','2000331569','2000331639','2000331644','2000332003','2000332295','2000332298','2000332530','2000332509','2000332890','2000333185','2000333211','2000333377','2000333698','2000333836','2000333895','2000310128','2000310406','2000314297','2000317367','2000317491','2000317602','2000319064','2000319812','2000319973','2000319873','2000319866','2000321133','2000321083','2000322186','2000321562','2000320751','2000322474','2000322482','2000322727','2000323032','2000323324','2000324014','2000324912','2000325650','2000326197','2000326265','2000326705','2000327403','2000327499','2000327608','2000328124','2000328506','2000329350','2000329499','2000329599','2000329739','2000329845','2000330517','2000330767','2000332201','2000332008','2000332466','2000317005','2000317496','2000317500','2000317729','2000318782','2000319174','2000319332','2000319631','2000319656','2000320245','2000320408','2000320860','2000321583','2000321997','2000322445','2000322638','2000322640','2000322932','2000323266','2000323281','2000323822','2000323821','2000323788','2000324741','2000325394','2000325858','2000326151','2000326463','2000326196','2000326554','2000327541','2000326696','2000327798','2000326868','2000327872','2000328165','2000328162','2000327795','2000328245','2000328459','2000328611','2000328830','2000329069','2000329347','2000329278','2000329482','2000329629','2000329561','2000329723','2000329811','2000329262','2000330298','2000330479','2000331019','2000331197','2000331570','2000331394','2000331703','2000331857','2000332173','2000332463','2000332963','2000333010','2000333207','2000333377','2000333569','2000333609','2000331133','2000332751','2000334090','2000333999','2000334269','2000334690','2000328440','2000334468','2000334829','2000335952','2000336193','2000336309','2000336600','2000336872','2000337275','2000337337','2000337375','2000337660','2000337643','2000338027','2000337964','2000338149','2000339188','2000339596','2000339622','2000340084','2000340138','2000340249','2000340589','2000340563','2000340587','2000326708','2000340574','2000340267','2000340000','2000339947','2000335951','2000338931','2000338812','2000338669','2000338804','2000338402','2000338003','2000335459','2000337685','2000334938','2000335010','2000337599','2000335877','2000335951','2000334170','2000333314','2000326074','2000340254','2000340232','2000339986','2000339781','2000339479','2000337451','2000339168','2000339161','2000339004','2000338849','2000338446','2000338158','2000337974','2000337901','2000337871','2000337863','2000337567','2000337538','2000335008','2000335198','2000337262','2000331269','2000335313','2000335377','2000337096','2000336605','2000336506','2000336411','2000337708','2000336726','2000339564','2000337792','2000326985','2000334254','2000335405','2000335415','2000335590')) a 
LEFT JOIN 
(select * from (SELECT patientno, encounterid, operatedate, Value, row_number() over (partition by patientno, encounterid order by operatedate desc) rank FROM cdr_v_PATIENTVITALSIGN WHERE VitalSignId='3024' AND Value>=50 AND Value<=250) b WHERE b.rank = 1) c -- 身高
ON a.PatientNo = c.PatientNo and a.encounterid = c.encounterid 
LEFT JOIN 
(select * from (SELECT patientno, encounterid, operatedate, Value, row_number() over (partition by patientno, encounterid order by operatedate desc) rank FROM cdr_v_PATIENTVITALSIGN WHERE VitalSignId='1014' AND Value>=20 AND Value<=200) d WHERE d.rank = 1) e -- 体重 
ON a.PatientNo = e.PatientNo and a.encounterid = e.encounterid;

-- 身高体重20211206
SELECT * FROM 
(SELECT DISTINCT patientno, inpatientnumber, encounterid FROM cdr_v_MEDICALRECORDMAIN WHERE inpatientnumber in ('2000308343', '2000308238', '2000310128', '2000310406', '2000312335', '2000311563', '2000314019', '2000312577', '2000312967', '2000314297', '2000317500', '2000317030', '2000317367', '2000317491', '2000317602', '2000318721', '2000318782', '2000319866', '2000319873', '2000319064', '2000319812', '2000321083', '2000320860', '2000321997', '2000320751', '2000321562', '2000321583', '2000322186', '2000322445', '2000322727', '2000323324', '2000323375', '2000323700', '2000323788', '2000323883', '2000324741', '2000324912', '2000325650', '2000325697', '2000326074', '2000326265', '2000326208', '2000327798', '2000327608', '2000328506', '2000328162', '2000328459', '2000328245', '2000329499', '2000329561', '2000329599', '2000329629', '2000329739', '2000329723', '2000329845', '2000331197', '2000330999')) a 
LEFT JOIN 
(select * from (SELECT patientno, encounterid, operatedate, Value, row_number() over (partition by patientno, encounterid order by operatedate desc) rank FROM cdr_v_PATIENTVITALSIGN WHERE VitalSignId='3024' AND Value>=50 AND Value<=250) b WHERE b.rank = 1) c -- 身高
ON a.PatientNo = c.PatientNo and a.encounterid = c.encounterid 
LEFT JOIN 
(select * from (SELECT patientno, encounterid, operatedate, Value, row_number() over (partition by patientno, encounterid order by operatedate desc) rank FROM cdr_v_PATIENTVITALSIGN WHERE VitalSignId='1014' AND Value>=20 AND Value<=200) d WHERE d.rank = 1) e -- 体重 
ON a.PatientNo = e.PatientNo and a.encounterid = e.encounterid;

-- 电话号码
SELECT DISTINCT patientno, inpatientnumber, currenttel as 现住址电话, workunittel as 工作单位电话, contacttel as 联系人电话  FROM cdr_v_MEDICALRECORDMAIN WHERE inpatientnumber in ('2000396677','200010975','20001902457','2000279196','2000308238','2000308343','2000308761','2000308823','2000309343','2000310000','2000310110','2000310128','2000310406','2000310811','2000311144','2000311563','2000312224','2000312331','2000312335','2000312416','2000312439','2000312577','2000312829','2000312868','2000312900','2000312967','2000313052','2000313245','2000313352','2000313371','2000313486','2000313654','2000314019','2000314090','2000314297','2000314517','2000315317','2000315436','2000316668','2000317030','2000317367','2000317408','2000317491','2000317496','2000317500','2000317602','2000317887','2000318024','2000318721','2000318782','2000318803','2000319064','2000319812','2000319866','2000319873','2000319944','2000320751','2000320860','2000320957','2000321083','2000321562','2000321583','2000321997','2000322186','2000322430','2000322445','2000322727','2000322905','2000323283','2000323324','2000323375','2000323700','2000323788','2000323883','2000324038','2000324627','2000324741','2000324782','2000324912','2000325084','2000325214','2000325650','2000325697','2000325706','2000326074','2000326184','2000326208','2000326265','2000326580','2000326777','2000327608','2000327798','2000327954','2000328162','2000328245','2000328459','2000328506','2000329499','2000329561','2000329599','2000329629','2000329723','2000329739','2000329845','2000329914','2000329939','2000330999','2000331197','2000331226','2000331333','2000331570','2000331703','2000332466','2000332476','2000332963','2000333257','2000334090','2000334690','2000334934','2000335951','2000335956','2000336054','2000336193','2000336244','2000337781','2000339564','2000339596','2000339622','2000339781','2000339883','2000339947','2000340000','2000340132','2000340249','2000340574','2000340587','2000340689','2000340711','2000340722','2000341347','2000341474','2000341557','2000342256','2000342346','2000342524','2000342747','2000343322','2000343324','2000343601','2000343704','2000343843','2000343971','2000344146','2000344602','2000345117','2000345462','2000345661','2000345674','2000345984','2000346310','2000346714','2000347505','2000348911','2000350278','2000351531','2000351676','2000352254','2000352351','2000352913','2000353454','2000354233','2000354289','2000354893','2000355251','2000355383','2000355476','2000355568','2000355660','2000355912','2000356048','2000357663','2000358020','2000358314','2000358347','2000359305','2000359494','2000359691','2000359743','2000360918','2000361099','2000361196','2000361471','2000362032','2000362139','2000362390','2000362747','2000364090','2000364442','2000365890','2000366053','2000366108','2000366167','2000366261','2000366972','2000368108','2000368374','2000368426','2000368806','2000368822','2000368960','2000369525','2000369814','2000369843','2000370020','2000370125','2000370754','2000371187','2000373743','2000374346','2000374435','2000374617','2000376093','2000377991','2000378119','2000378508','2000378707','2000379260','2000379547','2000380194','2000380447','2000380490','2000380774','2000382127','2000383002','2000383103','2000383953','2000383967','2000385154','2000385496','2000385506','2000385515','2000386096','2000386728','2000386767','2000387523','2000388305','2000388855','2000389390','2000389879','2000390335','2000390525','2000390865','2000390960','2000391253','2000391632','2000391853','2000391858','2000392078','2000392164','2000392348','2000393450','2000393491','2000393887','2000394072','2000394164','2000394698','2000394900','2000394957','2000395192','2000395240','2000395609','2000395700','2000395779','2000396272','2000396398','2000396443','2000397220','2000397260','2000397472','2000397768','2000397913','2000397947','2000398037','2000398059','2000398070','2000398675','2000398840','2000398989','2000399597','2000400197','2000400388','2000401453','2000401752','2000401771','2000401786','2000401962','2000401970','2000402416','2000402518','2000402569','2000404060','2000404313','2000405057','2000405594','2000405799','2000406057','2000406324','2000406491','2000406663','2000406848','2000406870','2000407217','2000407299','2000407438','2000408388','2000408516','2000408816','2000409487','2000410763','2000410873','2000410875','2000410900','2000411128','2000411500','2000412112','2000412227','2000412354','2000412775','2000412828','2000413013','2000413104','2000413290','2000413490','2000414043','2000414267','2000414741','2000415244','2000415285','2000415740','2000416012','2000416355','2000416649','2000416811','2000416965','2000416970','2000417522','2000417616','2000417618','2000417749','2000418375','2000418415','2000418836','2000418897','2000419012','2000419023','2000419163','2000419328','2000419527','2000419801','2000419931','2000419954','2000420144','2000421057','2000421616','2000422498','2000422602','2000423358','2000423644','2000423858','2000424396','2000424610','2000425447','2000426206','2000426331','2000426336','2000426520','2000426893','2000427001','2000427190','2000427700','2000427776','2000429560','2000429682','2000430151','2000430453','2000430484','2000430489','2000430944','2000432459','2000432563','2000433386','2000433388','2000433922','2000434060','2000434212','2000434270','2000434883','2000434889','2000435064','2000435454','2000435460','2000436260','2000436458','2000436650','2000436928','2000438044','2000438050','2000438051','2000438197','2000438365','2000438604','2000438786','2000439692','2000439871','2000439977','2000440024','2000440861','2000440916','2000441025','2000441049','2000441181','2000441722','2000442621','2000442634','2000443677','2000443823','2000443841','2000443879','2000444010','2000444479','2000444547','2000444813','2000445787','2000445800','2000445891','2000445930','2000445942','2000446447','2000446648','2000446690','2000446963','2000447538','2000447685','2000450092','2000450234','2000450245','2000450461','2000450821','2000450872','2000451030','2000451300','2000451949','2000452286','2000452422','2000453074','2000453312','2000453361','2000453883','2000453965','2000454628','2000454637','2000454779','2000455716','2000456151','2000457556','2000457698','2000457897','2000458044','2000458503','2000458684','2000458687','2000458873','2000459219','2000459237','2000459681','2000459740','2000459779','2000460902','2000461559','2000461696','2000461720','2000462051','2000462430');

